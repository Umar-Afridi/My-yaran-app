<script>
  // Right click ÿ±Ÿà⁄©ŸÜ€í ⁄©€í ŸÑ€å€í
  document.addEventListener('contextmenu', event => event.preventDefault());

  // Keyboard shortcuts (Ctrl+U, Ctrl+S) ÿ±Ÿà⁄©ŸÜ€í ⁄©€í ŸÑ€å€í
  document.onkeydown = function(e) {
    if (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 73)) {
      return false;
    }
  };
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <title>YARAAN</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Roboto:wght:400;500;700&display=swap');
        
        :root {
            --app-bg: #ffffff; 
            --active-text: #000000; 
            --inactive-text: #9ca3af; 
            --seat-size: 68px;
            --bottom-bar-height: 45px; 
        }

        html, body { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--app-bg) !important; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        body { font-family: 'Montserrat', sans-serif; color: #1f2937; overflow: hidden; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        #app-container { flex: 1; display: flex; flex-direction: column; position: relative; background-color: var(--app-bg); height: 100%; overflow: hidden; }
        
        /* HEADER */
        #app-header { background-color: var(--app-bg) !important; border: none !important; padding-top: 15px; padding-bottom: 5px; display: none; flex-direction: row; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px; z-index: 50; white-space: nowrap; height: 50px; flex-shrink: 0; }
        .tabs-wrapper { display: flex; align-items: baseline; gap: 15px; }
        .home-tab { font-family: 'Montserrat', sans-serif; background: none; border: none; cursor: pointer; padding: 0; margin: 0; transition: all 0.2s ease; font-size: 14px; font-weight: 500; color: var(--inactive-text); }
        .home-tab.active { font-size: 19px; font-weight: 800; color: var(--active-text); border-bottom: 2px solid #000; padding-bottom: 2px; } 
        .header-icons { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .icon-btn { font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* CAROUSEL CSS */
        .modern-carousel { position: relative; width: 100%; height: 150px; overflow: hidden; border-radius: 12px; background: #f0f0f0; margin-top: 5px; touch-action: pan-y; }
        .carousel-track { display: flex; height: 100%; transition: transform 0.5s ease-in-out; width: 100%; }
        .carousel-slide { min-width: 100%; height: 100%; position: relative; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .carousel-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10; }
        .dot { width: 6px; height: 6px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; transition: all 0.3s ease; }
        .dot.active { width: 16px; border-radius: 10px; background-color: #ffffff; }

        /* 3 ICON MENU CSS */
        .mid-menu-container { display: flex; justify-content: space-between; padding: 5px 15px 15px 15px; gap: 10px; }
        .mid-menu-item { flex: 1; height: 70px; border-radius: 10px; overflow: hidden; background: #fafafa; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mid-menu-img { width: 100%; height: 100%; object-fit: fill; }

        /* GRID ROOM LAYOUT CSS */
        #home-room-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            row-gap: 25px; 
            padding: 0 15px 80px 15px; 
        }

        .room-card-wrapper { display: flex; flex-direction: column; gap: 6px; }
        .room-card-new {
            position: relative; aspect-ratio: 1 / 1.1; border-radius: 12px; overflow: hidden; background-color: #f3f4f6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%;
        }
        .room-card-cover { width: 100%; height: 100%; object-fit: cover; }
        .room-card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 8px; display: flex; align-items: flex-end; justify-content: center; }
        .room-live-tag { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); border: 1px solid #22c55e; color: #22c55e; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .room-user-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; cursor: pointer; z-index: 20; }
        .room-card-title { color: white; font-size: 14px; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .room-info-bottom { display: flex; align-items: center; gap: 6px; padding-left: 2px; }
        .room-gender-icon { width: 16px; height: 16px; object-fit: contain; }
        .room-owner-name { font-size: 12px; font-weight: 600; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* GENERAL STYLES */
        .visual-root { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: visible !important; }
        .visual-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 78%; height: 78%; border-radius: 50%; object-fit: cover; z-index: 10; }
        .visual-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 270% !important; height: 270% !important; object-fit: contain; z-index: 20; pointer-events: none; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8)); }
        .profile-page-visual { width: 90px; height: 90px; position: relative; display: flex; align-items: center; justify-content: center; overflow: visible !important; flex-shrink: 0; }
        .frame-preview-box { width: 80px; height: 80px; position: relative; margin: 15px 0; display: flex; align-items: center; justify-content: center; overflow: visible !important; }

        .view-section { flex: 1; overflow-y: auto; padding-bottom: 80px; display: none; flex-direction: column; position: relative; width: 100%; height: 100%; }
        .view-active { display: flex !important; animation: fadeIn 0.2s ease; }
        .light-bg { background-color: var(--app-bg) !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* MAIN BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--app-bg) !important; border: none !important; display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: max(5px, env(safe-area-inset-bottom)); height: calc(60px + env(safe-area-inset-bottom)); box-shadow: none !important; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #9ca3af; transition: 0.3s; flex: 1; padding: 10px 0; }
        .nav-item i { font-size: 22px; margin-bottom: 3px; }
        .nav-item.active { color: #dc2626; font-weight: bold; }

        /* ROOM VIEW */
        #view-room { 
            display: none; 
            flex-direction: column; 
            height: 100dvh; 
            width: 100%; 
            padding-bottom: 0 !important; 
            background: #000 !important; 
            position: fixed; 
            inset: 0; 
            z-index: 60; 
            padding-top: env(safe-area-inset-top); 
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden; 
        }
        
        #room-top-content { flex-shrink: 0; }

        .cinema-frame { position: relative; width: 96%; margin: 5px auto; aspect-ratio: 16/9; background: #000000; overflow: hidden; z-index: 10; border-radius: 20px; border: 1px solid #222; box-shadow: 0 5px 20px rgba(0,0,0,0.5); flex-shrink: 0; }
        #video-controls-wrapper { transition: all 0.4s ease-in-out; max-height: 200px; opacity: 1; overflow: hidden; margin-bottom: 5px; flex-shrink: 0; }
        
        #room-lower-half {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin-top: 5px;
            min-height: 0; 
        }

        #theme-video-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
        }

        /* MICS AREA */
        #mics-scroll-area { 
            flex-shrink: 0; 
            overflow: visible; 
            padding-top: 10px; 
            background: transparent !important; 
            z-index: 10;
            position: relative;
            height: auto;
        }
        
        .mics-container-main { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 5px; padding-top: 15px; padding-bottom: 5px; width: 100%; }
        
        .seat-base { position: relative; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 50%; overflow: visible !important; }
        .mic-container-lg { width: 70px; height: 70px; }
        .mic-container-sm { width: 55px; height: 55px; }

        .chair-bg-img { position: absolute; width: 65%; height: 65%; object-fit: contain; opacity: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6)); z-index: 5; pointer-events: none; }
        .user-dp-visual { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 20; border-radius: 50%; }

        .top-mic-row { display: flex; justify-content: center; align-items: center; gap: 2px; margin-bottom: 10px; }
        .bottom-mic-row { display: flex; gap: 12px; justify-content: center; align-items: flex-start; flex-wrap: wrap; }
        .mic-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        
        .has-frame .user-dp-visual { background: transparent; }
        .seat-mute-badge { position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #ef4444; z-index: 30; }
        .seat-mute-badge i { font-size: 10px; color: #ef4444; }

        .action-menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); border-radius: 50%; z-index: 150; gap: 3px; }
        .btn-action { font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 4px; color: white; cursor: pointer; text-transform: uppercase; width: 90%; text-align: center; }
        .btn-green { background: #22c55e; } .btn-red { background: #ef4444; } .btn-yellow { background: #eab308; color: black; } .btn-blue { background: #3b82f6; }
        
        /* CHAT AREA */
        #chat-display-area { 
            flex: 1; width: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; padding: 10px 15px; z-index: 20; display: flex; flex-direction: column; justify-content: flex-end; position: relative; background: transparent !important; color: white !important; text-shadow: 0 1px 2px black; padding-bottom: 10px; margin-bottom: 0; mask-image: linear-gradient(to bottom, transparent 0%, black 15%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%);
        }
        .chat-message-bubble { background: rgba(20, 20, 20, 0.7); backdrop-filter: blur(3px); padding: 6px 12px; border-radius: 15px; margin-bottom: 6px; border: 1px solid rgba(255, 255, 255, 0.15); color: white !important; font-size: 12px; max-width: 85%; width: fit-content; word-wrap: break-word; animation: slideInUp 0.2s ease-out; text-shadow: 0 1px 1px black; flex-shrink: 0; }
        .chat-message-bubble b { color: #facc15; margin-right: 5px; }
        .chat-system-msg { align-self: center; background: rgba(255, 255, 255, 0.2); color: #eee; font-size: 10px; font-style: italic; padding: 4px 10px; border-radius: 20px; margin: 5px 0; text-align: center; border: none; width: auto; max-width: 90%; flex-shrink: 0; text-shadow: 0 1px 2px black; }
        
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ROOM BOTTOM BAR */
        #room-bottom-bar { position: relative; flex-shrink: 0; width: 100%; height: var(--bottom-bar-height); padding: 0 25px; padding-bottom: max(2px, env(safe-area-inset-bottom)); background: transparent !important; border-top: none; display: flex; align-items: center; justify-content: space-between; z-index: 100; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
        .room-icon-btn { font-size: 16px; color: #ffffff; cursor: pointer; transition: 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        /* CHAT INPUT LAYER */
        #room-chat-input-layer { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #111; padding: 10px 15px; z-index: 1000; align-items: center; gap: 10px; border-top: 1px solid #333; padding-bottom: max(10px, env(safe-area-inset-bottom)); }

        #search-overlay { position: absolute; top: 70px; left: 0; width: 100%; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); z-index: 40; padding: 20px; transform: translateY(-150%); transition: transform 0.3s ease-out; border-bottom: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        #search-overlay.open { transform: translateY(0); }
        #edit-modal, #prophouse-modal, #create-room-view, #room-settings-modal, #friend-profile-modal, #room-users-modal, #theme-modal { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); display: none; flex-direction: column; }
        #edit-modal, #room-settings-modal, #friend-profile-modal, #room-users-modal, #theme-modal { align-items: center; justify-content: center; background: rgba(0,0,0,0.85); }
        #edit-modal.open, #prophouse-modal.open, #create-room-view.open, #room-settings-modal.open, #friend-profile-modal.open, #room-users-modal.open, #theme-modal.open { display: flex; }
        .frame-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; overflow-y: auto; padding-bottom: 50px; }
        .frame-card { background: #080808; border: 1px solid #222; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; position: relative; transition: transform 0.2s; }
        
        .chat-bubble-me { background: #dc2626; color: white; align-self: flex-end; border-radius: 12px 12px 0 12px; } 
        .chat-bubble-friend { background: #333; color: white; align-self: flex-start; border-radius: 12px 12px 12px 0; }
        
        #guest-touch-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 500; display: none; cursor: pointer; }
        #pull-refresh-indicator { height: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: transparent; color: #dc2626; font-size: 20px; transition: height 0.2s; }
        #room-exit-bar { position: absolute; top: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); display: none; justify-content: space-between; align-items: center; padding: 0 30px; z-index: 2000; border-bottom: 1px solid rgba(255,255,255,0.1); padding-top: env(safe-area-inset-top); }
        #room-exit-blocker { position: absolute; top: 100px; left: 0; width: 100%; height: calc(100% - 100px); background: rgba(0,0,0,0.5); z-index: 1900; display: none; }
        .exit-icon-btn { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        .icon-img { width: 75px; height: 75px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.8)); transition: transform 0.2s; }
        .exit-icon-btn:active .icon-img { transform: scale(0.9); }
        
        .heartbeat-wrapper { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px; overflow: visible !important; opacity: 0; transition: opacity 0.5s ease; z-index: 5; margin-left: 2px; margin-right: 2px; }
        .heartbeat-active { opacity: 1; }
        .hb-img { width: 35px; height: 35px; object-fit: contain; z-index: 10; filter: drop-shadow(0 0 15px rgba(220, 38, 38, 0.9)); }
        .heartbeat-active .hb-img { animation: lovelyHeartBeat 1.2s infinite ease-in-out; }
        @keyframes lovelyHeartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .line-img { position: absolute; top: 50%; transform: translateY(-50%); height: 30px; width: 50px; object-fit: contain; z-index: 1; pointer-events: none; }
        .left-line { right: 25px; } .right-line { left: 25px; }
        
        #empty-state-trigger { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 40; width: 100%; height: 100%; pointer-events: none; }
        .empty-icon { font-size: 50px; color: rgba(255, 255, 255, 0.3); margin-bottom: 10px; }
        .empty-text { color: rgba(255, 255, 255, 0.3); font-size: 14px; font-weight: 500; }
        #auth-bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .auth-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 0; }
        #auth-content-wrapper { z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding: 30px; padding-bottom: 60px; }
        .auth-logo-container { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .auth-logo-png { width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); margin-bottom: 20px; border-radius: 15px; border: 2px solid white; }
        .auth-buttons-group { width: 100%; max-width: 320px; display: flex; flex-direction: column; align-items: center; }
        .google-sign-btn { width: 100%; max-width: 320px; background: white; color: #333; font-family: 'Roboto', sans-serif; font-weight: 500; display: flex; align-items: center; justify-content: center; position: relative; padding: 12px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 10px; transition: transform 0.2s; cursor: pointer; }
        .google-sign-btn:active { transform: scale(0.98); }
        .google-icon-svg { position: absolute; left: 15px; width: 24px; height: 24px; }
        .email-login-trigger { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); transition: background 0.2s; margin-top: 10px; }
        .email-login-trigger:hover { background: rgba(255,255,255,0.3); }
        .yaarann-text-design { font-size: 14px; font-weight: bold; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); margin-top: 10px; }
        #email-auth-full-page { position: fixed; inset: 0; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: opacity 0.3s ease-in-out; opacity: 0; padding: 20px; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        #email-auth-full-page.open { display: flex; opacity: 1; }
        .email-form-box { width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(200, 200, 200, 0.5); border-radius: 16px; padding: 30px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        #auth-email-form-container input { background: #f1f1f1; border: 1px solid #ccc; color: #333; }
        .menu-list-container { background: white; margin-top: 10px; padding-bottom: 20px; }
        .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: white; cursor: pointer; transition: background 0.2s; }
        .menu-item:active { background: #f9fafb; }
        .menu-icon-box { width: 24px; text-align: center; margin-right: 12px; }
        .menu-text { flex: 1; font-size: 14px; color: #374151; font-weight: 500; }
        .menu-arrow { color: #d1d5db; font-size: 12px; }
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        @keyframes spin-visual { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* GENDER SELECTOR STYLES */
        .gender-options { display: flex; gap: 20px; justify-content: center; margin-top: 10px; margin-bottom: 10px; }
        .gender-option { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; opacity: 0.5; transition: all 0.2s; }
        .gender-option.selected { opacity: 1; transform: scale(1.1); }
        .gender-img { width: 40px; height: 40px; object-fit: contain; }
        .locked-gender { filter: grayscale(1); cursor: not-allowed; }

        /* NEW CREATE ROOM FULL SCREEN */
        #create-room-view { background: #000; color: white; display: none; align-items: center; justify-content: center; padding: 30px; }
        .cr-cover-preview { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #dc2626; object-fit: cover; margin-bottom: 30px; background: #222; }
        .cr-input { background: #222; border: 1px solid #333; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 15px; outline: none; text-align: center; }
        .cr-input:focus { border-color: #dc2626; }
        .cr-btn { background: #dc2626; width: 100%; padding: 15px; border-radius: 30px; font-weight: bold; font-size: 16px; margin-top: 20px; box-shadow: 0 0 15px rgba(220, 38, 38, 0.5); }

        /* --- UPDATED ROCKET SYSTEM STYLES (MATCHING SCREENSHOT) --- */
        #rocket-trigger-btn {
            position: absolute;
            bottom: 70px; /* Sits above the bottom bar */
            right: 15px;  /* Aligned to right */
            width: 50px;
            height: 50px;
            z-index: 50;
            cursor: pointer;
            animation: floatRocket 3s ease-in-out infinite;
        }

        .rocket-display-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
        }

        @keyframes floatRocket {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Flying Animation Layer */
        #rocket-fly-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* BIG ROCKET FOR LAUNCH */
        .flying-rocket {
            width: 70vw; 
            max-width: 400px;
            height: auto;
            position: relative;
            transform: translateY(20px);
            opacity: 1;
            z-index: 3002;
            filter: drop-shadow(0 0 20px rgba(255, 100, 0, 0.8));
        }

        /* COUNTDOWN STYLE */
        .rocket-countdown {
            font-size: 100px;
            font-weight: 900;
            color: #facc15;
            text-shadow: 0 0 20px black, 0 0 40px red;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3005;
            animation: pulseCount 1s infinite;
        }
        
        @keyframes pulseCount {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Shake/Rumble Animation */
        .rocket-rumble {
            animation: rumble 0.1s infinite;
        }
        @keyframes rumble {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 5px); }
            50% { transform: translate(5px, -5px); }
            75% { transform: translate(-5px, -5px); }
            100% { transform: translate(0, 0); }
        }

        .rocket-launching {
            animation: bigLaunch 2.5s ease-in-out forwards;
        }

        .sparkle-effect {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
            animation: sparkleAnim 1s ease-out forwards;
        }

        @keyframes sparkleAnim {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes bigLaunch {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            20% { transform: translateY(20px) scale(0.9); opacity: 1; } 
            100% { transform: translateY(-150vh) scale(0.5); opacity: 0; }
        }

        /* --- UPDATED PURPLE MODAL STYLES (SCREENSHOT 2) --- */
        #rocket-details-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
        }

        /* Purple/Cosmic Card */
        .rocket-modal-card {
            background: linear-gradient(180deg, #2e0249 0%, #5b0a91 100%);
            border: 2px solid #d946ef;
            border-radius: 24px;
            width: 95%;
            max-width: 400px;
            height: 80vh;
            display: flex;
            position: relative;
            padding: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
        }

        .modal-left-col {
            width: 25%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            padding-top: 20px;
        }

        .modal-level-btn {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            cursor: pointer;
            position: relative;
        }

        .modal-level-btn.active {
            border-color: #facc15;
            background: rgba(250, 204, 21, 0.2);
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }

        .modal-center-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .big-center-rocket {
            width: 150px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.5));
            /* No continuous animation here to match static display in modal usually, or keep hover */
        }

        .modal-right-col {
            width: 15%;
            display: flex;
            justify-content: center;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        /* Tube Progress Bar */
        .tube-container {
            width: 30px;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
        }

        .tube-fill {
            width: 100%;
            background: linear-gradient(to top, #22c55e, #a3e635);
            transition: height 0.5s ease;
        }
        
        .tube-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 0 1px 2px black;
        }

        .rewards-panel {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            padding: 0 20px;
        }
        
        .rewards-box {
            background: rgba(0,0,0,0.5);
            border: 1px solid #d946ef;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .reward-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #facc15;
            font-size: 10px;
        }

        .reward-img { width: 30px; height: 30px; object-fit: contain; margin-bottom: 5px; }

        /* Gift Modal Styles */
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .gift-item { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; border: 1px solid transparent; }
        .gift-item:hover { border-color: #facc15; background: rgba(255,255,255,0.2); }
        .gift-img { width: 40px; height: 40px; object-fit: contain; margin: 0 auto; }
        .gift-price { font-size: 10px; color: #facc15; margin-top: 2px; display: block; }
    </style>
</head>
<body>
    
    <input type="file" id="image-upload" accept="image/*" style="display: none;">
    <input type="file" id="video-upload" accept="video/*" style="display: none;">

    <audio id="rocket-sound" src="https://assets.mixkit.co/active_storage/sfx/2558/2558-preview.mp3" preload="auto"></audio>

    <div id="app-container">
        
        <header id="app-header">
            <div id="header-home-content" class="w-full flex items-center justify-between">
                <div class="tabs-wrapper">
                    <button onclick="switchHomeTab('following')" id="tab-following" class="home-tab">Following</button>
                    <button onclick="switchHomeTab('popular')" id="tab-popular" class="home-tab active">Popular</button>
                    <button onclick="switchHomeTab('recent')" id="tab-recent" class="home-tab">Recent</button>
                </div>
                <div class="header-icons">
                    <button onclick="toggleSearch()" class="icon-btn text-gray-800"><i class="fa-solid fa-magnifying-glass"></i></button>
                    <button onclick="triggerCreateRoom()" class="icon-btn text-red-600"><i class="fa-solid fa-square-plus"></i></button>
                </div>
            </div>
            <div id="header-inbox-content" class="w-full hidden">
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Messages</h1> 
            </div>
            <div id="header-profile-content" class="w-full hidden"></div>
        </header>

        <div id="floating-room-btn" style="position: fixed; bottom: 90px; right: 20px; width: 65px; height: 65px; border-radius: 50%; background: black; border: 2px solid #dc2626; z-index: 60; display: none; align-items: center; justify-content: center; animation: pulse-ring 2s infinite; cursor: grab; touch-action: none; overflow: hidden;">
            <img id="float-btn-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
            <i class="fa-solid fa-music" style="position: absolute; font-size: 24px; color: white; filter: drop-shadow(0 2px 2px black); z-index: 10;"></i>
        </div>

        <div id="search-overlay">
            <div class="flex gap-2">
                <input type="number" id="search-input" placeholder="User ID" class="flex-1 bg-gray-50 border border-gray-300 rounded-full px-4 py-2 text-gray-900 focus:outline-none focus:border-red-600 appearance-none shadow-sm">
                <button onclick="searchUser()" class="bg-red-700 text-white px-4 rounded-full shadow"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <div id="search-result" class="mt-4"></div>
            <button onclick="toggleSearch()" class="mt-4 text-xs text-gray-500 w-full text-center">Close Search</button>
        </div>

        <!-- Create Room Full Screen Overlay -->
        <div id="create-room-view">
            <button onclick="closeCreateRoom()" class="absolute top-5 right-5 text-gray-400 text-2xl"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-2xl font-bold mb-8 uppercase tracking-wider">Setup Room</h2>
            
            <img id="cr-preview" src="https://placehold.co/200x200?text=Cover" class="cr-cover-preview">
            
            <div class="w-full max-w-xs">
                <label class="text-xs text-gray-400 ml-2 uppercase">Room Name</label>
                <input type="text" id="cr-name" class="cr-input" placeholder="Enter Room Name">
                
                <label class="text-xs text-gray-400 ml-2 uppercase">Cover Image URL</label>
                <input type="text" id="cr-cover" class="cr-input" placeholder="Paste Image Link" oninput="document.getElementById('cr-preview').src = this.value || 'https://placehold.co/200x200?text=Cover'">
                
                <button onclick="finalizeCreateRoom()" class="cr-btn">GO LIVE</button>
            </div>
        </div>

        <!-- Room Settings Modal -->
        <div id="room-settings-modal">
            <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm border border-gray-300 relative shadow-2xl">
                <button onclick="closeRoomSettings()" class="absolute top-3 right-3 text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-gray-900 font-bold mb-4 text-center">Room Settings</h3>
                
                <div class="space-y-3">
                    <div><label class="text-xs text-gray-500">Room Name</label><input type="text" id="rs-name" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none" placeholder="Room Name"></div>
                    <div><label class="text-xs text-gray-500">Cover URL</label><input type="text" id="rs-cover" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none text-xs" placeholder="Image URL"></div>
                    
                    <div class="flex items-center justify-between bg-gray-100 p-2 rounded border border-gray-200 mt-2">
                        <span class="text-sm font-bold text-gray-700">Lock Room (Private)</span>
                        <input type="checkbox" id="rs-lock" class="w-5 h-5 accent-red-600">
                    </div>
                    
                    <div onclick="openThemeModal()" class="flex items-center justify-between bg-gray-800 text-white p-3 rounded cursor-pointer mt-2">
                        <span class="font-bold">Room Themes</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
                <button onclick="saveRoomSettings()" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded mt-6 shadow-md">SAVE SETTINGS</button>
            </div>
        </div>
        
        <!-- THEME MODAL -->
        <div id="theme-modal">
            <div class="bg-zinc-900 p-6 rounded-xl w-11/12 max-w-sm border border-zinc-700 relative shadow-2xl overflow-y-auto max-h-[80vh]">
                <button onclick="closeThemeModal()" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-white font-bold mb-4 text-center">Select Room Theme</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <!-- Theme 1 -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme1.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+1'">
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme1.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                    <!-- Theme 2 -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme2.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+2'">
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme2.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                    <!-- Theme 3 -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme3.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+3'">
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme3.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                    <!-- Theme 4 -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme4.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+4'">
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme4.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                    <!-- Theme 5 -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme5.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+5'">
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme5.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                    <!-- Theme 6 (VIDEO) -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <div class="w-full h-20 bg-gray-800 rounded mb-2 flex items-center justify-center text-white text-xs font-bold">VIDEO THEME 6</div>
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme6.mp4')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                    <!-- Theme 7 (VIDEO) -->
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <div class="w-full h-20 bg-gray-800 rounded mb-2 flex items-center justify-center text-white text-xs font-bold">VIDEO THEME 7</div>
                        <div class="flex gap-1 w-full">
                            <button onclick="applyTheme('theme7.mp4')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button>
                            <button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-modal">
            <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm border border-gray-300 relative shadow-2xl">
                <button onclick="closeEditModal()" class="absolute top-3 right-3 text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-gray-900 font-bold mb-4 text-center">Edit Profile</h3>
                
                <div class="flex flex-col items-center mb-2">
                    <div class="profile-page-container" style="width: 100px; height: 100px;">
                        <div id="edit-preview-visual" class="visual-root"></div>
                    </div>
                    <div class="flex gap-3 text-xs mt-2">
                        <button onclick="triggerImageUpload()" class="text-blue-600 font-medium hover:underline">Upload File</button>
                    </div>
                </div>

                <!-- Gender Selection -->
                <div class="gender-options">
                    <div class="gender-option" id="opt-male" onclick="selectGender('male')">
                        <img src="./male.png" class="gender-img" onerror="this.src='https://placehold.co/40?text=M'">
                        <span class="text-[10px] font-bold text-gray-500">MALE</span>
                    </div>
                    <div class="gender-option" id="opt-female" onclick="selectGender('female')">
                        <img src="./female.png" class="gender-img" onerror="this.src='https://placehold.co/40?text=F'">
                        <span class="text-[10px] font-bold text-gray-500">FEMALE</span>
                    </div>
                </div>
                <p id="gender-lock-msg" class="text-[9px] text-red-500 text-center mb-3 hidden">Gender change locked for 7 days.</p>

                <div class="space-y-3">
                    <div><input type="text" id="edit-name" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none" placeholder="Display Name"></div>
                    <div><input type="text" id="edit-img-url" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none text-xs" placeholder="Image URL (Optional)"></div>
                    <!-- Registered Email Readonly -->
                    <div><input type="text" id="edit-email" disabled class="w-full bg-gray-200 border border-gray-300 rounded p-2 text-gray-600 outline-none text-xs cursor-not-allowed" placeholder="Registered Email"></div>
                    <div><textarea id="edit-bio" rows="2" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none" placeholder="Bio"></textarea></div>
                </div>
                <button onclick="saveProfile()" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded mt-6 shadow-md">SAVE PROFILE</button>
            </div>
        </div>
        
        <!-- FRIEND PROFILE MODAL -->
        <div id="friend-profile-modal">
            <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm border border-gray-300 relative shadow-2xl flex flex-col items-center">
                <button onclick="closeFriendProfile()" class="absolute top-3 right-3 text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                
                <div class="w-24 h-24 rounded-full border-2 border-red-600 mb-3 overflow-hidden">
                    <img id="fp-image" src="" class="w-full h-full object-cover">
                </div>
                
                <h3 id="fp-name" class="text-xl font-extrabold text-gray-900">User Name</h3>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs text-gray-400 font-bold uppercase">ID: <span id="fp-id">0000</span></span>
                    <img id="fp-gender" src="" class="w-4 h-4 object-contain">
                </div>
                
                <p id="fp-bio" class="text-center text-sm text-gray-600 italic mb-4 px-2">No bio available.</p>
                
                <button id="fp-action-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded-full shadow-lg transition transform active:scale-95">FOLLOW</button>
            </div>
        </div>

        <!-- ROOM USERS LIST MODAL -->
        <div id="room-users-modal">
            <div class="bg-gray-900 p-5 rounded-xl w-11/12 max-w-sm border border-gray-700 relative shadow-2xl max-h-[80%] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h3 class="text-white font-bold text-lg">Room Users</h3>
                    <button onclick="closeRoomUsers()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div id="room-users-list" class="flex-1 overflow-y-auto space-y-2"></div>
            </div>
        </div>

        <div id="prophouse-modal">
            <div class="flex justify-between items-center mb-6 border-b border-zinc-800 pb-4">
                <h2 class="text-2xl font-bold text-white tracking-wider">PROP <span class="text-red-600">HOUSE</span></h2>
                <button onclick="closePropHouse()" class="text-gray-400 text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="frame-grid" class="frame-grid flex-1"></div>
        </div>

        <div id="view-auth" class="view-section z-50 fixed inset-0">
            <video id="auth-bg-video" autoplay muted loop playsinline>
                <source src="./login_bg.mp4" type="video/mp4">
            </video>
            <div class="auth-overlay"></div>

            <div id="auth-content-wrapper">
                <div class="auth-logo-container">
                    <img src="./app_icon.png" class="auth-logo-png" alt="App Icon">
                    <h1 class="text-4xl font-bold mb-2 text-white drop-shadow-lg">‚òÖùêòùêöùê´ùêöùêöùêß‚òÖ</h1> 
                </div>
                <div id="auth-main-screen" class="auth-buttons-group">
                    <button onclick="loginWithGoogle()" class="google-sign-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" class="google-icon-svg"><span>Sign in with Google</span></button>
                    <div class="yaarann-text-design"><span class="text-gray-400">** * *</span> ‚òÖùêòùêöùê´ùêöùêöùêß‚òÖ <span class="text-gray-400">* * **</span></div>
                    <div onclick="showEmailForm()" class="email-login-trigger"><i class="fa-solid fa-envelope"></i></div>
                </div>
            </div>
        </div>
        
        <div id="email-auth-full-page">
            <div class="email-form-box">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="email-form-title" class="text-2xl font-bold text-gray-900">Email Login</h2>
                    <button onclick="hideEmailForm()" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <form id="auth-form" class="space-y-4 text-left">
                    <div id="username-field" class="hidden"><label class="text-xs text-gray-500 ml-2">Name</label><input type="text" id="username" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-red-600 outline-none"></div>
                    <input type="email" id="email" placeholder="Email" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-red-600 outline-none">
                    <input type="password" id="password" placeholder="Password" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-red-600 outline-none">
                    <button type="submit" id="auth-btn" class="w-full bg-red-700 py-3 rounded-lg font-bold shadow-lg mt-4 text-white">LOGIN</button>
                </form>
                <p onclick="toggleAuthMode()" id="auth-switch" class="mt-4 text-center text-sm text-gray-600 cursor-pointer hover:text-red-600 transition">Create an account</p>
            </div>
        </div>

        <div id="view-home" class="view-section light-bg">
            <div id="pull-refresh-indicator"><i class="fa-solid fa-rotate-right fa-spin"></i></div>
            
            <div class="px-4">
                <div class="modern-carousel" id="main-banner-carousel">
                    <div class="carousel-track" id="banner-track">
                        <div class="carousel-slide"><img src="./banner1.png" class="carousel-img" onerror="this.src='https://placehold.co/600x200?text=Banner+1'"></div>
                        <div class="carousel-slide"><img src="./banner2.png" class="carousel-img" onerror="this.src='https://placehold.co/600x200?text=Banner+2'"></div>
                        <div class="carousel-slide"><img src="./banner3.png" class="carousel-img" onerror="this.src='https://placehold.co/600x200?text=Banner+3'"></div>
                    </div>
                    <div class="carousel-dots" id="banner-dots"></div>
                </div>
            </div>
            
            <div class="mid-menu-container">
                <div class="mid-menu-item"><img src="./icon_contribution.png" class="mid-menu-img" onerror="this.src='https://placehold.co/100x70?text=Contrib'"></div>
                <div class="mid-menu-item"><img src="./icon_charm.png" class="mid-menu-img" onerror="this.src='https://placehold.co/100x70?text=Charm'"></div>
                <div class="mid-menu-item"><img src="./icon_room.png" class="mid-menu-img" onerror="this.src='https://placehold.co/100x70?text=Room'"></div>
            </div>

            <div id="home-content-container">
                <h3 class="text-sm font-extrabold px-4 mt-2 mb-1 text-gray-800 tracking-wider">ROOMS</h3>
                <div id="home-room-list"></div>
            </div>
        </div>

        <div id="view-inbox" class="view-section light-bg">
            <div class="p-4">
                <div id="requests-section">
                    <h2 class="text-xs font-bold uppercase tracking-widest mb-2">Notifications</h2>
                    <div id="inbox-list" class="space-y-2 mb-6"></div>
                </div>
                <h2 class="text-xs font-bold uppercase tracking-widest mb-2">My Following (Chat)</h2>
                <div id="friends-chat-list" class="space-y-2"></div>
            </div>
        </div>

        <div id="view-chat" class="view-section bg-white flex-col hidden" style="z-index: 100;">
            <div class="flex items-center gap-3 p-4 border-b border-gray-200 bg-gray-100 shadow-sm sticky top-0 z-10" id="dm-header">
                <button onclick="closeDirectChat(); event.stopPropagation();" class="text-gray-600"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="font-bold text-gray-900 flex-1 cursor-pointer flex flex-col" onclick="viewFriendProfile(currentChatFriendId)">
                    <span id="dm-friend-name">Friend</span>
                    <span class="text-[10px] text-gray-500 font-normal">Tap to view profile</span>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
            </div>
            <div id="dm-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50"></div>
            <form id="dm-form" class="p-3 bg-white border-t border-gray-200 flex gap-2 sticky bottom-0 z-20 pb-[env(safe-area-inset-bottom)]">
                <input type="text" id="dm-input" placeholder="Message..." class="flex-1 bg-gray-100 border border-gray-300 rounded-full px-4 text-black focus:outline-none">
                <button type="submit" class="text-blue-500 px-2"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>

        <div id="view-profile" class="view-section light-bg">
            <div onclick="openEditModal()" class="flex items-center p-5 bg-white cursor-pointer relative">
                <div class="profile-page-visual mr-4" id="profile-visual-container"></div>
                <div class="flex-1 flex flex-col justify-center">
                    <h2 id="profile-name" class="text-2xl font-extrabold text-gray-900 mb-0.5">...</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400 text-xs font-bold uppercase tracking-wide">ID:</span>
                        <span id="profile-id" class="text-gray-800 font-mono text-base font-bold">...</span>
                        <div onclick="copyToClipboard(document.getElementById('profile-id').innerText); event.stopPropagation();" class="p-1 cursor-pointer active:scale-90 transition"><i class="fa-regular fa-copy text-gray-400 text-xs ml-1"></i></div>
                    </div>
                </div>
                <div class="flex items-center justify-center"><i class="fa-solid fa-chevron-right text-gray-300 text-lg"></i></div>
            </div>
            <p id="profile-bio" class="text-gray-500 text-xs px-5 pb-3 bg-white truncate italic">...</p>
            <div class="flex justify-around items-center bg-white border-t border-b border-gray-100 py-3 mb-2">
                <div onclick="showFriendList('following')" class="flex flex-col items-center flex-1 border-r border-gray-100 cursor-pointer active:bg-gray-50"><span id="stat-following" class="font-bold text-lg text-gray-900">0</span><span class="text-[10px] text-gray-500 uppercase tracking-wide">Follow</span></div>
                <div onclick="showFriendList('fans')" class="flex flex-col items-center flex-1 cursor-pointer active:bg-gray-50"><span id="stat-fans" class="font-bold text-lg text-gray-900">0</span><span class="text-[10px] text-gray-500 uppercase tracking-wide">Fans</span></div>
            </div>
            <div class="bg-white flex flex-col pb-10">
                <div class="menu-list-container">
                    <div class="menu-item"><div class="menu-icon-box"><i class="fa-solid fa-wallet text-yellow-500 text-lg"></i></div><div class="menu-text">Recharge & Wallet</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="showInviteModal()"><div class="menu-icon-box"><i class="fa-solid fa-user-plus text-green-500 text-lg"></i></div><div class="menu-text">Invite friends</div><span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full mr-2">Invite</span><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="openPropHouse()"><div class="menu-icon-box"><i class="fa-solid fa-store text-blue-500 text-lg"></i></div><div class="menu-text">Store</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item"><div class="menu-icon-box"><i class="fa-solid fa-heart text-pink-500 text-lg"></i></div><div class="menu-text">Love House</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item"><div class="menu-icon-box"><i class="fa-solid fa-crown text-purple-500 text-lg"></i></div><div class="menu-text">CP Level</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="openPropHouse()"><div class="menu-icon-box"><i class="fa-solid fa-warehouse text-green-600 text-lg"></i></div><div class="menu-text">Prop Warehouse</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item"><div class="menu-icon-box"><i class="fa-solid fa-medal text-orange-500 text-lg"></i></div><div class="menu-text">Medal</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item"><div class="menu-icon-box"><i class="fa-solid fa-shield-halved text-red-400 text-lg"></i></div><div class="menu-text">Level</div><span class="text-xs text-gray-400 mr-2 font-bold">LV.1</span><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="logout()"><div class="menu-icon-box"><i class="fa-solid fa-power-off text-red-600 text-lg"></i></div><div class="menu-text text-red-600">Logout</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                </div>
            </div>
        </div>

        <!-- ================== UPDATED ROOM VIEW WITH NEW SEAT DESIGN ================== -->
        <div id="view-room">
            <div id="room-exit-bar">
                <button onclick="minimizeRoom()" class="exit-icon-btn">
                    <img src="./minimize.png" class="icon-img" alt="Minimize">
                </button>
                <button onclick="leaveRoomFull()" class="exit-icon-btn">
                    <img src="./exit.png" class="icon-img" alt="Leave">
                </button>
            </div>
            <div id="room-exit-blocker" onclick="closeExitMenu()"></div>

            <div id="room-top-content">
                <div class="flex items-center justify-between px-4 py-2 bg-zinc-900 border-b border-zinc-800">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <img id="room-header-cover" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full border border-gray-600 object-cover flex-shrink-0">
                        <div class="flex flex-col min-w-0">
                            <span id="room-header-name" class="text-sm font-bold text-white truncate">Room Name</span>
                            <div class="flex items-center text-[10px] text-gray-400">
                                <span>ID: <span id="room-header-id">00000</span></span>
                                <span class="mx-1">|</span>
                                <i class="fa-solid fa-users text-gray-500 mr-1"></i>
                                <span id="room-user-count" onclick="showRoomUserList()" class="font-bold text-white cursor-pointer hover:text-red-500 underline">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 items-center flex-shrink-0">
                        <button onclick="window.showInviteModal()" class="text-white hover:text-green-400"><i class="fa-solid fa-user-plus text-lg"></i></button>
                        <button onclick="window.openRoomSettings()" class="text-white hover:text-blue-400"><i class="fa-solid fa-gear text-lg"></i></button>
                        <button onclick="window.toggleExitMenu()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket text-lg"></i></button>
                    </div>
                </div>

                <div class="w-full flex-shrink-0" onclick="hideAllMicMenus(event)">
                    <div class="cinema-frame relative group">
                        
                        <div id="guest-touch-blocker" onclick="handleGuestTap()"></div>
                        
                        <div id="empty-state-trigger">
                            <i class="fa-solid fa-video empty-icon"></i>
                            <span class="empty-text">Play Video</span>
                        </div>

                        <div id="screen-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-black text-zinc-800"></div>
                        <iframe id="video-iframe" class="w-full h-full hidden absolute inset-0 z-10" style="object-fit: contain; width: 100%; height: 100%; background: black;" src="" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture; gyroscope" allowfullscreen></iframe>
                        <video id="local-video-player" class="w-full h-full hidden absolute inset-0 z-20" style="background: black;" controls playsinline></video>
                    </div>
                    
                    <div id="video-controls-wrapper">
                        <div class="flex items-center gap-2 px-4 py-2 bg-black border-b border-zinc-800 overflow-x-auto">
                            <input type="text" id="direct-yt-link" placeholder="Paste YouTube Link..." class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-red-600">
                            <button onclick="playDirectVideo()" class="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap"><i class="fa-solid fa-play mr-1"></i> PLAY</button>
                            <button onclick="window.clearScreen()" class="bg-gray-700 text-white px-3 py-1 rounded text-xs font-bold border border-gray-600 whitespace-nowrap">CLEAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROOM LOWER HALF - with updated seat design -->
            <div id="room-lower-half">
                <video id="theme-video-bg" loop muted playsinline class="hidden absolute top-0 left-0 w-full h-full object-cover -z-10"></video>

                <!-- ROCKET SYSTEM BUTTON (NEW) -->
                <div id="rocket-trigger-btn" onclick="openRocketDetails()">
                    <img src="./rocket1.png" class="w-full h-full object-contain filter drop-shadow-lg">
                </div>
                
                <!-- Rocket Details Modal -->
                <div id="rocket-details-modal">
                    <div class="rocket-modal-card">
                        <button onclick="closeRocketDetails()" class="absolute top-2 right-3 text-gray-400 z-50"><i class="fa-solid fa-xmark text-xl"></i></button>

                        <!-- Left Column: Levels -->
                        <div class="modal-left-col">
                            <div class="modal-level-btn" id="btn-lvl-4">
                                <span>LV.4</span>
                            </div>
                            <div class="modal-level-btn" id="btn-lvl-3">
                                <span>LV.3</span>
                            </div>
                            <div class="modal-level-btn" id="btn-lvl-2">
                                <span>LV.2</span>
                            </div>
                            <div class="modal-level-btn" id="btn-lvl-1">
                                <span>LV.1</span>
                            </div>
                        </div>

                        <!-- Center Column: Big Rocket Display -->
                        <div class="modal-center-col">
                            <img id="modal-big-rocket" src="./rocket1.png" class="big-center-rocket">
                            
                            <div class="rewards-panel">
                                <div class="rewards-box">
                                    <div class="reward-item">
                                        <img src="https://placehold.co/40?text=F" class="reward-img">
                                        <span>Frame x1</span>
                                    </div>
                                    <div class="reward-item">
                                        <img src="https://placehold.co/40?text=E" class="reward-img">
                                        <span>Entry x1</span>
                                    </div>
                                    <div class="reward-item">
                                        <img src="https://placehold.co/40?text=B" class="reward-img">
                                        <span>Badge x1</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Tube Progress -->
                        <div class="modal-right-col">
                            <div class="tube-container">
                                <div id="rocket-tube-fill" class="tube-fill"></div>
                                <div id="rocket-tube-text" class="tube-percent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flying Animation Layer -->
                <div id="rocket-fly-layer"></div>

                <div id="mics-scroll-area">
                    <div class="mics-container-main">
                        <!-- TOP ROW - Large seats (UMAR & GURIYA) with chair background -->
                        <div class="top-mic-row flex justify-center items-center gap-2">
                            <!-- Seat 1 (UMAR) -->
                            <div class="mic-wrapper" id="wrapper-seat1">
                                <div class="seat-base mic-container-lg" id="cont-seat1" onclick="toggleMicMenu('seat1', 'UMAR', event)">
                                    <img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'">
                                    <div id="seat1-visual" class="user-dp-visual"></div>
                                    <div id="menu-seat1" class="action-menu-overlay"></div>
                                </div>
                                <span id="seat1-name" class="seat-name">UMAR</span>
                            </div>

                            <!-- Heartbeat Container -->
                            <div id="heartbeat-container" class="heartbeat-wrapper">
                                <img src="./left.png" class="line-img left-line" alt="Left Line">
                                <img src="./couple_heart.png" class="hb-img" alt="Heart">
                                <img src="./right.png" class="line-img right-line" alt="Right Line">
                            </div>

                            <!-- Seat 2 (GURIYA) -->
                            <div class="mic-wrapper" id="wrapper-seat2">
                                <div class="seat-base mic-container-lg" id="cont-seat2" onclick="toggleMicMenu('seat2', 'GURIYA', event)">
                                    <img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'">
                                    <div id="seat2-visual" class="user-dp-visual"></div>
                                    <div id="menu-seat2" class="action-menu-overlay"></div>
                                </div>
                                <span id="seat2-name" class="seat-name">GURIYA</span>
                            </div>
                        </div>

                        <!-- BOTTOM ROW - Small seats (1-4) with chair background -->
                        <div class="bottom-mic-row flex justify-center gap-3 flex-wrap">
                            <!-- Seat 3 -->
                            <div class="mic-wrapper" id="wrapper-seat3">
                                <div class="seat-base mic-container-sm" id="cont-seat3" onclick="toggleMicMenu('seat3', '1', event)">
                                    <img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'">
                                    <div id="seat3-visual" class="user-dp-visual"></div>
                                    <div id="menu-seat3" class="action-menu-overlay"></div>
                                </div>
                                <span id="seat3-name" class="seat-name">1</span>
                            </div>
                            <!-- Seat 4 -->
                            <div class="mic-wrapper" id="wrapper-seat4">
                                <div class="seat-base mic-container-sm" id="cont-seat4" onclick="toggleMicMenu('seat4', '2', event)">
                                    <img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'">
                                    <div id="seat4-visual" class="user-dp-visual"></div>
                                    <div id="menu-seat4" class="action-menu-overlay"></div>
                                </div>
                                <span id="seat4-name" class="seat-name">2</span>
                            </div>
                            <!-- Seat 5 -->
                            <div class="mic-wrapper" id="wrapper-seat5">
                                <div class="seat-base mic-container-sm" id="cont-seat5" onclick="toggleMicMenu('seat5', '3', event)">
                                    <img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'">
                                    <div id="seat5-visual" class="user-dp-visual"></div>
                                    <div id="menu-seat5" class="action-menu-overlay"></div>
                                </div>
                                <span id="seat5-name" class="seat-name">3</span>
                            </div>
                            <!-- Seat 6 -->
                            <div class="mic-wrapper" id="wrapper-seat6">
                                <div class="seat-base mic-container-sm" id="cont-seat6" onclick="toggleMicMenu('seat6', '4', event)">
                                    <img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'">
                                    <div id="seat6-visual" class="user-dp-visual"></div>
                                    <div id="menu-seat6" class="action-menu-overlay"></div>
                                </div>
                                <span id="seat6-name" class="seat-name">4</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chat-display-area"></div>
            </div>
            
            <div id="room-bottom-bar">
                <div class="flex items-center justify-between w-full" id="room-icons-container">
                    <i onclick="openRoomChatInput()" class="fa-solid fa-comment-dots room-icon-btn"></i>
                    <i onclick="minimizeRoom(); switchTab('view-inbox', document.getElementById('btn-inbox'))" class="fa-solid fa-inbox room-icon-btn"></i>
                    <i onclick="toggleMic()" id="btn-mic" class="fa-solid fa-microphone room-icon-btn text-white"></i>
                    <i onclick="toggleSpeaker()" id="btn-speaker" class="fa-solid fa-volume-high room-icon-btn text-white"></i>
                    <i onclick="document.getElementById('gift-modal').classList.remove('hidden')" class="fa-solid fa-gift room-icon-btn text-pink-400"></i>
                </div>
                
                <form id="room-chat-input-layer" onsubmit="sendRoomMessage(event)">
                    <button type="button" onclick="closeRoomChatInput()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
                    <input type="text" id="room-chat-input-field" placeholder="Type here..." class="flex-1 bg-zinc-800 border border-zinc-700 rounded-full px-4 py-2 text-sm text-white focus:outline-none">
                    <button type="submit" class="text-blue-500"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
        
        <nav id="bottom-nav" class="bottom-nav hidden">
            <div class="nav-item active" id="btn-home" onclick="switchTab('view-home', this)"><i class="fa-solid fa-house"></i><span>Home</span></div>
            <div class="nav-item" id="btn-inbox" onclick="switchTab('view-inbox', this)"><div class="relative"><i class="fa-solid fa-inbox"></i><div id="inbox-dot" class="absolute top-0 right-0 w-2 h-2 bg-red-600 rounded-full hidden"></div></div><span>Inbox</span></div>
            <div class="nav-item" id="btn-profile" onclick="switchTab('view-profile', this)"><i class="fa-solid fa-user"></i><span>Me</span></div>
        </nav>
    </div>

    <!-- Gift Modal -->
    <div id="gift-modal" class="hidden fixed inset-0 bg-black/80 z-[200] flex flex-col justify-end">
        <div onclick="document.getElementById('gift-modal').classList.add('hidden')" class="flex-1"></div>
        <div class="bg-gray-900 rounded-t-2xl p-4 border-t border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold">Send Gifts</h3>
                <span class="text-yellow-400 text-xs font-bold">Coins: Unlimited</span>
            </div>
            <div class="gift-grid">
                <div class="gift-item" onclick="sendGift('Rose', 10000)">
                    <img src="https://placehold.co/50?text=üåπ" class="gift-img">
                    <span class="gift-price">10k</span>
                </div>
                <div class="gift-item" onclick="sendGift('Ring', 50000)">
                    <img src="https://placehold.co/50?text=üíç" class="gift-img">
                    <span class="gift-price">50k</span>
                </div>
                <div class="gift-item" onclick="sendGift('Car', 300000)">
                    <img src="https://placehold.co/50?text=üèéÔ∏è" class="gift-img">
                    <span class="gift-price">300k</span>
                </div>
                <div class="gift-item" onclick="sendGift('Rocket', 500000)">
                    <img src="https://placehold.co/50?text=üöÄ" class="gift-img">
                    <span class="gift-price">500k</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onValue, update, remove, child, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDsINqjN-WfgOHYm592c0Hq1zyoonDJ5qI",
            authDomain: "yaraan-app-b2296.firebaseapp.com",
            databaseURL: "https://yaraan-app-b2296-default-rtdb.firebaseio.com",
            projectId: "yaraan-app-b2296",
            storageBucket: "yaraan-app-b2296.firebasestorage.app",
            messagingSenderId: "39282278939",
            appId: "1:39282278939:web:2337152b888edd03af2ebe"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentRoomId = null;
        let currentRoomOwner = null;
        let currentRoomData = null; 
        let currentUserJoinTime = 0; 
        let currentChatFriendId = null;
        let isSignup = false;
        let currentEditingImg = null;
        let currentHomeTab = 'popular'; 
        let currentRoomSeats = {};
        let selectedGender = null;
        let isMicMuted = false;
        let isSpeakerMuted = false;

        const tabs = ['following', 'popular', 'recent'];

        // --- ROCKET SYSTEM LOGIC ---
        const ROCKET_LEVELS = [
            { level: 1, cost: 300000, img: './rocket1.png' },
            { level: 2, cost: 500000, img: './rocket2.png' },
            { level: 3, cost: 2000000, img: './rocket3.png' },
            { level: 4, cost: 3000000, img: './rocket4.png' }
        ];

        let currentRoomExp = 0;
        let lastRocketLevel = 0;

        function initRocketListener(rid) {
            // New logic: ensure new button is visible instead of old container
            document.getElementById('rocket-trigger-btn').classList.remove('hidden');
            
            // Listen to Room Experience/Coins
            onValue(ref(db, `rooms/${rid}/roomExp`), (snap) => {
                currentRoomExp = snap.val() || 0;
                updateRocketUI(currentRoomExp);
            });
        }

        function updateRocketUI(exp) {
            let targetLevel = 0;
            let targetImg = './rocket1.png'; // Default
            let nextThreshold = ROCKET_LEVELS[0].cost;
            let prevThreshold = 0;

            // Determine Level
            for (let i = 0; i < ROCKET_LEVELS.length; i++) {
                if (exp >= ROCKET_LEVELS[i].cost) {
                    targetLevel = ROCKET_LEVELS[i].level;
                    targetImg = ROCKET_LEVELS[i].img;
                    prevThreshold = ROCKET_LEVELS[i].cost;
                    // Set next threshold
                    if (i < ROCKET_LEVELS.length - 1) {
                        nextThreshold = ROCKET_LEVELS[i+1].cost;
                    } else {
                        nextThreshold = exp * 1.5; // Max level reached
                    }
                }
            }

            // Update Display Image inside the new Trigger Button
            // Note: The img tag inside #rocket-trigger-btn doesn't have an ID, we target it via querySelector
            const triggerImg = document.querySelector('#rocket-trigger-btn img');
            if (triggerImg) triggerImg.src = targetImg;
            
            // Also update Modal Big Rocket
            document.getElementById('modal-big-rocket').src = targetImg;
            
            // Highlight Level Buttons
            document.querySelectorAll('.modal-level-btn').forEach(btn => btn.classList.remove('active'));
            if(targetLevel >= 1) document.getElementById('btn-lvl-1').classList.add('active');
            if(targetLevel >= 2) document.getElementById('btn-lvl-2').classList.add('active');
            if(targetLevel >= 3) document.getElementById('btn-lvl-3').classList.add('active');
            if(targetLevel >= 4) document.getElementById('btn-lvl-4').classList.add('active');

            // Calculate Percentage for Tube
            let percentage = 0;
            if (targetLevel < 4) {
                percentage = ((exp - prevThreshold) / (nextThreshold - prevThreshold)) * 100;
            } else {
                percentage = 100;
            }
            percentage = Math.max(0, Math.min(100, percentage));

            // Vertical Tube Update
            document.getElementById('rocket-tube-fill').style.height = `${percentage}%`;
            document.getElementById('rocket-tube-text').innerText = `${Math.floor(percentage)}%`;

            // --- ANIMATION TRIGGER ---
            if (targetLevel > lastRocketLevel && lastRocketLevel !== 0) {
                const isMaxLevel = (targetLevel === 4);
                playRocketAnimation(targetImg, isMaxLevel);
                
                push(ref(db, `rooms/${currentRoomId}/messages`), { 
                    name: "System", 
                    text: `üöÄ Room Leveled Up to Rocket ${targetLevel}!`, 
                    type: 'system', 
                    timestamp: Date.now() 
                });
            }
            lastRocketLevel = targetLevel;
        }

        window.openRocketDetails = () => document.getElementById('rocket-details-modal').style.display='flex';
        window.closeRocketDetails = () => document.getElementById('rocket-details-modal').style.display='none';

        function playRocketAnimation(imgSrc, isMaxLevel) {
            const layer = document.getElementById('rocket-fly-layer');
            layer.style.display = 'flex'; // Make visible

            // HTML Structure: Rocket Image + Countdown Div
            layer.innerHTML = `
                <div id="rocket-countdown-display" class="rocket-countdown">8</div>
                <img src="${imgSrc}" id="active-flying-rocket" class="flying-rocket rocket-rumble" style="opacity: 1;">
            `;

            let count = 8;
            const counterEl = document.getElementById('rocket-countdown-display');
            const rocketEl = document.getElementById('active-flying-rocket');
            const audio = document.getElementById('rocket-sound');

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    counterEl.innerText = count;
                } else {
                    // Launch Time!
                    clearInterval(interval);
                    counterEl.style.display = 'none'; // Hide numbers

                    // Play Sound
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log(e));

                    // Change Animation: Stop rumble, Start Launch
                    rocketEl.classList.remove('rocket-rumble');
                    rocketEl.classList.add('rocket-launching');

                    // Sparkle Effect
                    for(let i=0; i<20; i++) {
                        const spark = document.createElement('div');
                        spark.className = 'sparkle-effect';
                        spark.style.left = Math.random() * 100 + '%';
                        spark.style.top = Math.random() * 100 + '%';
                        spark.style.animationDelay = Math.random() + 's';
                        layer.appendChild(spark);
                    }

                    // Reset Logic if Level 4
                    if (isMaxLevel) {
                        setTimeout(() => {
                            // Reset Database Exp to 0
                            set(ref(db, `rooms/${currentRoomId}/roomExp`), 0);
                            push(ref(db, `rooms/${currentRoomId}/messages`), {
                                name: "System",
                                text: "‚ú® Rocket Cycle Reset! Start again! ‚ú®",
                                type: 'system',
                                timestamp: Date.now()
                            });
                        }, 2000); // Reset shortly after launch starts
                    }

                    // Cleanup Layer
                    setTimeout(() => {
                        layer.style.display = 'none';
                        layer.innerHTML = '';
                    }, 2500); // 2.5s duration for flight
                }
            }, 1000); // 1 second intervals
        }

        window.sendGift = async (giftName, cost) => {
            if(!currentRoomId) return;

            const expRef = ref(db, `rooms/${currentRoomId}/roomExp`);
            await runTransaction(expRef, (currentExp) => {
                return (currentExp || 0) + cost;
            });

            await push(ref(db, `rooms/${currentRoomId}/messages`), { 
                name: currentUser.displayName, 
                text: `Sent ${giftName} üéÅ (Exp +${cost})`, 
                type: 'gift', 
                timestamp: Date.now() 
            });

            document.getElementById('gift-modal').classList.add('hidden');
            Swal.fire({toast:true, icon:'success', title:`Sent ${giftName}!`, position:'center', timer:1000, showConfirmButton:false});
        };

        // --- BANNER CAROUSEL LOGIC ---
        const bannerTrack = document.getElementById('banner-track');
        const bannerDots = document.getElementById('banner-dots');
        let bannerIndex = 0;
        let bannerInterval;
        const totalBanners = 3; 

        for(let i=0; i<totalBanners; i++) {
            const dot = document.createElement('div');
            dot.classList.add('dot');
            if(i === 0) dot.classList.add('active');
            bannerDots.appendChild(dot);
        }

        function updateBanner() {
            bannerTrack.style.transform = `translateX(-${bannerIndex * 100}%)`;
            const dots = document.querySelectorAll('.dot');
            dots.forEach((d, idx) => {
                if(idx === bannerIndex) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        function nextBanner() {
            bannerIndex = (bannerIndex + 1) % totalBanners;
            updateBanner();
        }

        function startAutoBanner() {
            if(bannerInterval) clearInterval(bannerInterval);
            bannerInterval = setInterval(nextBanner, 3000); 
        }

        let bannerStartX = 0;
        const bannerContainer = document.getElementById('main-banner-carousel');
        
        bannerContainer.addEventListener('touchstart', (e) => {
            bannerStartX = e.touches[0].clientX;
            e.stopPropagation(); 
            clearInterval(bannerInterval); 
        }, {passive: false});

        bannerContainer.addEventListener('touchmove', (e) => { e.stopPropagation(); }, {passive: false});

        bannerContainer.addEventListener('touchend', (e) => {
            e.stopPropagation(); 
            const endX = e.changedTouches[0].clientX;
            const diff = endX - bannerStartX;
            if (diff > 50) { bannerIndex = (bannerIndex - 1 + totalBanners) % totalBanners; updateBanner(); } 
            else if (diff < -50) { bannerIndex = (bannerIndex + 1) % totalBanners; updateBanner(); }
            startAutoBanner(); 
        }, {passive: false});

        startAutoBanner();

        // --- DRAGGABLE FLOATING BUTTON LOGIC ---
        const floatBtn = document.getElementById('floating-room-btn');
        let isDragging = false;
        let dragStartX, dragStartY, btnStartX, btnStartY;

        floatBtn.addEventListener('touchstart', (e) => {
            isDragging = false;
            dragStartX = e.touches[0].clientX;
            dragStartY = e.touches[0].clientY;
            const rect = floatBtn.getBoundingClientRect();
            btnStartX = rect.left;
            btnStartY = rect.top;
        }, {passive: false});

        floatBtn.addEventListener('touchmove', (e) => {
            isDragging = true;
            e.preventDefault(); 
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const deltaX = currentX - dragStartX;
            const deltaY = currentY - dragStartY;
            
            floatBtn.style.left = (btnStartX + deltaX) + 'px';
            floatBtn.style.top = (btnStartY + deltaY) + 'px';
            floatBtn.style.bottom = 'auto'; 
            floatBtn.style.right = 'auto';
        }, {passive: false});

        floatBtn.onclick = (e) => { if(!isDragging) { restoreRoom(); } };

        // --- AUTH LOGIC ---
        window.showEmailForm = () => {
            document.getElementById('email-auth-full-page').classList.add('open');
            document.getElementById('auth-form').reset();
            isSignup = false;
            document.getElementById('username-field').classList.add('hidden');
            document.getElementById('auth-btn').textContent = "LOGIN";
            document.getElementById('auth-switch').textContent = "Create an account";
            document.getElementById('email-form-title').textContent = "Email Login";
        }
        window.hideEmailForm = () => { document.getElementById('email-auth-full-page').classList.remove('open'); }

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userRef = ref(db, `users/${user.uid}`);
                const snap = await get(userRef);
                if(!snap.exists()) { await generateAndSaveId(user.uid, user.displayName, user.email, user.photoURL); }
                localStorage.setItem('user_logged_in', 'true');
            } catch (error) { Swal.fire('Login Error', error.message, 'error'); }
        };

        // --- GESTURE LOGIC ---
        let touchStartX = 0; let touchStartY = 0;
        document.addEventListener('touchstart', e => { if(e.target.closest('.modern-carousel')) return; touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false});
        document.addEventListener('touchend', e => { if(e.target.closest('.modern-carousel')) return; let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; handleGesture(touchStartX, touchStartY, touchEndX, touchEndY); }, {passive: false});

        function handleGesture(sX, sY, eX, eY) {
            const diffX = eX - sX; const diffY = eY - sY;
            if (Math.abs(diffX) < 50) return;
            const roomView = document.getElementById('view-room');
            const profileView = document.getElementById('view-profile');
            const propModal = document.getElementById('prophouse-modal');
            const homeView = document.getElementById('view-home');
            
            if (diffX < -50 && Math.abs(diffX) > Math.abs(diffY)) { 
                if (roomView.style.display === 'flex') { window.toggleExitMenu(); return; }
                if (profileView.style.display === 'flex') { switchTab('view-home', document.getElementById('btn-home')); return; }
                if (propModal.classList.contains('open')) { closePropHouse(); return; }
            }
            if (homeView.style.display === 'flex' && Math.abs(diffX) > Math.abs(diffY)) {
                 let currentIndex = tabs.indexOf(currentHomeTab);
                 if (diffX < -50 && currentIndex < tabs.length - 1) switchHomeTab(tabs[currentIndex + 1]); 
                 else if (diffX > 50 && currentIndex > 0) switchHomeTab(tabs[currentIndex - 1]); 
                 return;
            }
        }

        // --- PULL REFRESH ---
        const homeView = document.getElementById('view-home');
        const refreshIndicator = document.getElementById('pull-refresh-indicator');
        let homeStartY = 0;
        homeView.addEventListener('touchstart', (e) => { if (homeView.scrollTop === 0) homeStartY = e.touches[0].pageY; }, {passive: true});
        homeView.addEventListener('touchmove', (e) => { if (homeView.scrollTop === 0 && e.touches[0].pageY > homeStartY) refreshIndicator.style.height = `${(e.touches[0].pageY - homeStartY)/2}px`; }, {passive: true});
        homeView.addEventListener('touchend', () => { if (parseInt(refreshIndicator.style.height) > 30) { refreshIndicator.style.height = '40px'; refreshHomeRooms(); setTimeout(() => { refreshIndicator.style.height = '0px'; }, 1000); } else { refreshIndicator.style.height = '0px'; } });

        function forceScrollBottom() { 
            const chatArea = document.getElementById('chat-display-area'); 
            if (chatArea) { 
                chatArea.scrollTop = chatArea.scrollHeight;
            } 
        }
        window.addEventListener('resize', () => { if(currentRoomId) setTimeout(forceScrollBottom, 100); });
        
        window.toggleAuthMode = () => { 
            isSignup = !isSignup; 
            document.getElementById('username-field').classList.toggle('hidden'); 
            if (isSignup) { document.getElementById('auth-btn').textContent = "CREATE ACCOUNT"; document.getElementById('auth-switch').textContent = "Back to Login"; document.getElementById('email-form-title').textContent = "Create Account"; } 
            else { document.getElementById('auth-btn').textContent = "LOGIN"; document.getElementById('auth-switch').textContent = "Create an account"; document.getElementById('email-form-title').textContent = "Email Login"; }
        };
        
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const email = document.getElementById('email').value; const pass = document.getElementById('password').value;
            try { 
                if(isSignup) { 
                    const username = document.getElementById('username').value.trim(); 
                    if(!username) return Swal.fire('Error', 'Name required', 'error'); 
                    const cred = await createUserWithEmailAndPassword(auth, email, pass); 
                    await generateAndSaveId(cred.user.uid, username, email); 
                    await updateProfile(cred.user, { displayName: username, photoURL: `https://ui-avatars.com/api/?name=${username}&background=random` }); 
                    localStorage.setItem('user_logged_in', 'true');
                } else { 
                    await signInWithEmailAndPassword(auth, email, pass); 
                    localStorage.setItem('user_logged_in', 'true');
                } 
                hideEmailForm(); 
            } catch(err) { Swal.fire('Error', err.message, 'error'); }
        });

        async function generateAndSaveId(uid, username, email, photoURL) { const countRef = ref(db, 'sys/userCount'); const result = await runTransaction(countRef, (current) => (current || 0) + 1); const newId = 10000 + result.snapshot.val(); await set(ref(db, `users/${uid}`), { username: username, email: email, uid: uid, photoURL: photoURL || `https://ui-avatars.com/api/?name=${username}`, customId: newId, bio: "YARAAN User", currentFrame: null }); await set(ref(db, `idToUid/${newId}`), uid); return newId; }
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authView = document.getElementById('view-auth');
            if (user) {
                localStorage.setItem('user_logged_in', 'true');
                authView.classList.remove('view-active');
                authView.style.display = 'none'; 
                document.getElementById('bottom-nav').classList.remove('hidden'); 
                document.getElementById('bottom-nav').classList.add('flex'); 
                document.getElementById('app-header').style.display = 'flex';
                loadData();
                switchTab('view-home', document.querySelector('#btn-home')); 
                switchHomeTab('popular');
            } else {
                localStorage.removeItem('lastRoomId');
                localStorage.removeItem('user_logged_in');
                authView.style.display = 'flex';
                authView.classList.add('view-active');
            }
        });

        window.logout = () => { localStorage.removeItem('lastRoomId'); localStorage.removeItem('user_logged_in'); signOut(auth).then(()=> window.location.reload()); };
        window.switchHomeTab = (tabName) => { currentHomeTab = tabName; document.querySelectorAll('.home-tab').forEach(t => t.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.add('active'); refreshHomeRooms(); }

        // --- UPDATED ROOM LIST LOGIC ---
        window.refreshHomeRooms = async () => {
            if(!currentUser) return;
            const homeList = document.getElementById('home-room-list'); 
            homeList.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4 col-span-2">Loading...</p>';
            const roomsSnap = await get(ref(db, 'rooms'));
            if(!roomsSnap.exists()) { homeList.innerHTML = `<p class="text-gray-400 text-center mt-10 text-sm col-span-2">No live rooms found.</p>`; return; }
            const friendsSnap = await get(ref(db, `users/${currentUser.uid}/friends`));
            const friendIds = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];
            let history = JSON.parse(localStorage.getItem('room_history') || '[]');
            homeList.innerHTML = '';
            let hasLive = false;
            
            const promises = [];

            roomsSnap.forEach(r => { 
                const d = r.val(); const roomId = r.key;
                const isOwnerPresent = d.activeUsers && Object.keys(d.activeUsers).includes(d.owner);

                if (d.isLocked === true) return; 

                if (d.isLive === true && isOwnerPresent) { 
                    let shouldShow = false;
                    if (currentHomeTab === 'following') { if (friendIds.includes(d.owner) || d.owner === currentUser.uid) shouldShow = true; } 
                    else if (currentHomeTab === 'popular') shouldShow = true;
                    else if (currentHomeTab === 'recent') { if (history.includes(roomId)) shouldShow = true; }
                    
                    if (shouldShow) { 
                        hasLive = true;
                        const p = get(ref(db, `users/${d.owner}/gender`)).then(genderSnap => {
                            const gender = genderSnap.exists() ? genderSnap.val() : 'male'; 
                            return { ...d, id: roomId, gender: gender };
                        });
                        promises.push(p);
                    }
                } 
            }); 
            
            const results = await Promise.all(promises);

            results.forEach(d => {
                const roomNameDisplay = d.roomName || (d.ownerName + "'s Room");
                const roomCoverDisplay = d.roomCover || `https://ui-avatars.com/api/?name=${roomNameDisplay}&background=random&size=200`;
                const genderIcon = d.gender === 'female' ? './female.png' : './male.png';
                const userCount = d.activeUsers ? Object.keys(d.activeUsers).length : 0;

                homeList.innerHTML += `
                <div onclick="joinRoom('${d.id}')" class="room-card-wrapper cursor-pointer">
                    <div class="room-card-new">
                        <img src="${roomCoverDisplay}" class="room-card-cover" onerror="this.src='https://placehold.co/200x200?text=Room'">
                        <div class="room-live-tag"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> LIVE</div>
                        <div class="room-user-badge"><i class="fa-solid fa-user text-[8px]"></i><span>${userCount}</span></div>
                        <div class="room-card-overlay">
                            <div class="room-card-title">${roomNameDisplay}</div>
                        </div>
                    </div>
                    <div class="room-info-bottom">
                        <img src="${genderIcon}" class="room-gender-icon" onerror="this.src='https://placehold.co/16?text=G'">
                        <div class="room-owner-name">${d.ownerName}</div>
                    </div>
                </div>`; 
            });

            if(!hasLive) homeList.innerHTML = `<p class="text-gray-400 text-center mt-10 text-sm col-span-2">No live rooms.</p>`;
        }

        async function loadData() {
            const mySnap = await get(ref(db, `users/${currentUser.uid}`)); 
            if(mySnap.exists()) { 
                const d = mySnap.val(); 
                if (!d.customId || d.customId > 900000000) { await generateAndSaveId(currentUser.uid, d.username, d.email, d.photoURL); } 
                else { document.getElementById('profile-id').innerText = d.customId; } 
                document.getElementById('profile-name').innerText = d.username; 
                document.getElementById('profile-bio').innerText = d.bio || ""; 
                const container = document.getElementById('profile-visual-container'); 
                let html = `<div class="visual-root"><img src="${d.photoURL}" class="visual-img">`; 
                if(d.currentFrame) html += `<img src="${d.currentFrame}" class="visual-frame">`; 
                html += `</div>`; container.innerHTML = html; 
                document.getElementById('edit-preview-visual').innerHTML = html;
                
                selectedGender = d.gender || null;
                updateGenderUI(d.lastGenderChange);
            }
            onValue(ref(db, `users/${currentUser.uid}/friends`), async (snap) => { 
                const chatList = document.getElementById('friends-chat-list'); 
                chatList.innerHTML = ''; 
                let count = 0;
                if(snap.exists()) { 
                    count = Object.keys(snap.val()).length;
                    for (const [uid, name] of Object.entries(snap.val())) {
                        const fSnap = await get(ref(db, `users/${uid}`));
                        const fData = fSnap.val() || {};
                        const pic = fData.photoURL || `https://ui-avatars.com/api/?name=${name}`;
                        
                        chatList.innerHTML += `
                        <div onclick="openDirectChat('${uid}', '${name}')" class="bg-white p-3 rounded flex items-center justify-between cursor-pointer border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <img src="${pic}" class="w-10 h-10 rounded-full border border-gray-300 object-cover">
                                <span class="text-gray-900 text-sm font-medium">${name}</span>
                            </div>
                        </div>`; 
                    }
                }
                document.getElementById('stat-following').innerText = count;
                document.getElementById('stat-fans').innerText = count;
                refreshHomeRooms(); 
            });
            onValue(ref(db, `users/${currentUser.uid}/inbox`), snap => { const list = document.getElementById('inbox-list'); const badge = document.getElementById('inbox-dot'); list.innerHTML = ''; let count = 0; if(snap.exists()) { const data = snap.val(); if(data.requests) Object.entries(data.requests).forEach(([key, val]) => { count++; list.innerHTML += inboxItem(key, val, 'req'); }); if(data.invites) Object.entries(data.invites).forEach(([key, val]) => { count++; list.innerHTML += inboxItem(key, val, 'inv'); }); } if(count > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden'); });
        }
        function inboxItem(key, val, type) { 
            if(type === 'req') return `<div class="bg-white border border-gray-200 shadow-sm p-2 rounded flex justify-between items-center mb-1"><span class="text-xs text-gray-800 font-medium">Followed you: ${val.fromName}</span><div class="flex gap-2"><button onclick="acceptFriend('${val.fromUid}', '${val.fromName}')" class="text-blue-600 text-xs font-bold border border-blue-600 px-2 py-1 rounded hover:bg-blue-50">FOLLOW BACK</button><button onclick="delNotif('requests/${key}')" class="text-red-500"><i class="fa-solid fa-xmark"></i></button></div></div>`; 
            return `<div class="bg-white border border-gray-200 shadow-sm p-2 rounded flex justify-between items-center mb-1"><span class="text-xs text-gray-800 font-medium">Invite: ${val.fromName}</span><div class="flex gap-2"><button onclick="joinRoom('${val.roomId}')" class="text-blue-600 font-bold hover:underline">JOIN</button><button onclick="delNotif('invites/${key}')" class="text-red-500"><i class="fa-solid fa-xmark"></i></button></div></div>`; 
        }

        // --- CREATE ROOM LOGIC UPDATE ---
        window.triggerCreateRoom = async () => {
            const roomSnap = await get(ref(db, `rooms/${currentUser.uid}`));
            if(roomSnap.exists()) {
                joinRoom(currentUser.uid);
            } else {
                document.getElementById('cr-name').value = "";
                document.getElementById('cr-cover').value = "";
                document.getElementById('cr-preview').src = 'https://placehold.co/200x200?text=Cover';
                document.getElementById('create-room-view').classList.add('open');
            }
        };

        window.closeCreateRoom = () => { document.getElementById('create-room-view').classList.remove('open'); }

        window.finalizeCreateRoom = async () => {
            const rName = document.getElementById('cr-name').value;
            const rCover = document.getElementById('cr-cover').value;
            if(!rName) return Swal.fire('Error', 'Room Name is required', 'error');
            const myId = document.getElementById('profile-id').innerText; 
            await update(ref(db, `rooms/${currentUser.uid}`), { 
                owner: currentUser.uid, 
                ownerName: currentUser.displayName, 
                ownerCustomId: myId,
                active: true, 
                isLive: true,
                roomName: rName,
                roomCover: rCover || null 
            });
            closeCreateRoom();
            joinRoom(currentUser.uid);
        }

        window.openRoomSettings = async () => {
            if(!currentRoomId || currentRoomId !== currentUser.uid) {
                return Swal.fire('Access Denied', 'Only owner can change settings', 'warning');
            }
            const snap = await get(ref(db, `rooms/${currentRoomId}`));
            const d = snap.val();
            document.getElementById('rs-name').value = d.roomName || '';
            document.getElementById('rs-cover').value = d.roomCover || '';
            document.getElementById('rs-lock').checked = d.isLocked || false;
            document.getElementById('room-settings-modal').classList.add('open');
        }

        window.closeRoomSettings = () => document.getElementById('room-settings-modal').classList.remove('open');

        window.saveRoomSettings = async () => {
            const n = document.getElementById('rs-name').value;
            const c = document.getElementById('rs-cover').value;
            const l = document.getElementById('rs-lock').checked;
            await update(ref(db, `rooms/${currentRoomId}`), { roomName: n, roomCover: c, isLocked: l });
            document.getElementById('room-header-name').innerText = n;
            if(c) document.getElementById('room-header-cover').src = c;
            closeRoomSettings();
        }
        
        // --- THEME LOGIC START ---
        window.openThemeModal = () => {
            closeRoomSettings();
            document.getElementById('theme-modal').classList.add('open');
        }
        window.closeThemeModal = () => document.getElementById('theme-modal').classList.remove('open');
        
        window.applyTheme = async (themeName) => {
            if(!currentRoomId || currentRoomId !== currentUser.uid) return;
            await update(ref(db, `rooms/${currentRoomId}`), { theme: themeName });
            Swal.fire({toast:true, icon:'success', title:'Theme Applied', position:'top', timer:1500, showConfirmButton:false});
            closeThemeModal();
        }
        
        window.removeTheme = async () => {
            if(!currentRoomId || currentRoomId !== currentUser.uid) return;
            await update(ref(db, `rooms/${currentRoomId}`), { theme: null });
            Swal.fire({toast:true, icon:'info', title:'Theme Removed', position:'top', timer:1500, showConfirmButton:false});
            closeThemeModal();
        }
        // --- THEME LOGIC END ---

        window.handleGuestTap = () => { };
        
        window.playDirectVideo = () => {
             const input = document.getElementById('direct-yt-link');
             const val = input.value.trim();
             if(!val) return;
             let videoId = '';
             const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
             const match = val.match(ytRegExp);
             if (match && match[2].length == 11) { videoId = match[2]; } 
             else if(val.includes('shorts/')) { const parts = val.split('shorts/'); if(parts[1]) videoId = parts[1].split('?')[0]; }

             if(videoId && videoId.length > 5) { playVideoById(videoId); input.value = ""; } 
             else { Swal.fire({toast:true, icon:'error', title:'Invalid YouTube Link', position:'top'}); }
        };

        function playVideoById(id) { 
            set(ref(db, `rooms/${currentRoomId}/videoId`), {type:'yt', id:id, timestamp: Date.now()}); 
            push(ref(db, `rooms/${currentRoomId}/messages`), { name: "System", text: `${currentUser.displayName} started a video.`, type: 'system', timestamp: Date.now() }); 
        }

        window.joinRoom = async (rid) => { 
            let history = JSON.parse(localStorage.getItem('room_history') || '[]'); history = history.filter(id => id !== rid); history.unshift(rid); if(history.length > 20) history.pop(); localStorage.setItem('room_history', JSON.stringify(history)); localStorage.setItem('lastRoomId', rid);
            const kickSnap = await get(ref(db, `rooms/${rid}/kicked/${currentUser.uid}`)); if (kickSnap.exists()) { if (Date.now() - kickSnap.val() < 20 * 60 * 1000) { localStorage.removeItem('lastRoomId'); return Swal.fire('Banned', 'Kicked from room.', 'error'); } } 
            currentRoomId = rid; currentUserJoinTime = Date.now(); 
            
            get(ref(db, `rooms/${rid}`)).then(snap => { 
                currentRoomData = snap.val();
                currentRoomOwner = currentRoomData.owner;
                const rCover = currentRoomData.roomCover || `https://ui-avatars.com/api/?name=${currentRoomData.roomName}`;
                document.getElementById('room-header-cover').src = rCover;
                document.getElementById('room-header-name').innerText = currentRoomData.roomName;
                document.getElementById('room-header-id').innerText = currentRoomData.ownerCustomId || '...';
                document.getElementById('guest-touch-blocker').style.display = 'none'; 
                document.getElementById('empty-state-trigger').style.display = 'flex'; 
                
                // APPLY THEME IF EXISTS
                const theme = currentRoomData.theme;
                const area = document.getElementById('room-lower-half');
                const videoBg = document.getElementById('theme-video-bg');
                
                if(theme) {
                    if(theme.endsWith('.mp4')) {
                        area.style.backgroundImage = 'none';
                        videoBg.src = `./${theme}`;
                        videoBg.classList.remove('hidden');
                        videoBg.play().catch(e => console.log("Auto-play prevented"));
                    } else {
                        videoBg.classList.add('hidden');
                        videoBg.pause();
                        area.style.backgroundImage = `url('./${theme}')`;
                    }
                } else {
                    area.style.backgroundImage = 'none';
                    videoBg.classList.add('hidden');
                    videoBg.pause();
                }

                if(rid === currentUser.uid) { update(ref(db, `rooms/${rid}`), { isLive: true }); onDisconnect(ref(db, `rooms/${rid}/isLive`)).set(false); } 
            }); 

            onValue(ref(db, `rooms/${rid}/kicked/${currentUser.uid}`), (s) => { if(s.exists() && currentRoomId === rid) { leaveRoomFull(); Swal.fire('Kicked', 'Removed by host.', 'warning'); } }); 
            switchTab('view-room'); 
            
            // Rocket listener
            initRocketListener(rid);

            const userRef = ref(db, `rooms/${rid}/activeUsers/${currentUser.uid}`); set(userRef, currentUser.displayName); onDisconnect(userRef).remove();
            onValue(ref(db, `rooms/${rid}/activeUsers`), (snap) => { const count = snap.exists() ? Object.keys(snap.val()).length : 0; document.getElementById('room-user-count').innerText = count; });
            push(ref(db, `rooms/${rid}/messages`), { name: "System", text: `${currentUser.displayName} entered the room.`, type: 'system', timestamp: Date.now() });
            
            // LISTEN FOR THEME CHANGES LIVE
            onValue(ref(db, `rooms/${rid}/theme`), s => {
                const t = s.val();
                const area = document.getElementById('room-lower-half');
                const videoBg = document.getElementById('theme-video-bg');
                
                if(t) {
                    if(t.endsWith('.mp4')) {
                        area.style.backgroundImage = 'none';
                        videoBg.src = `./${t}`;
                        videoBg.classList.remove('hidden');
                        videoBg.play().catch(e => console.log("Playback error", e));
                    } else {
                        videoBg.classList.add('hidden');
                        videoBg.pause();
                        area.style.backgroundImage = `url('./${t}')`;
                    }
                } else {
                    area.style.backgroundImage = 'none';
                    videoBg.classList.add('hidden');
                    videoBg.pause();
                }
            });

            const rr = ref(db, `rooms/${rid}`);
            onValue(child(rr, 'videoId'), s => { 
                const v=s.val(); const iframe=document.getElementById('video-iframe'); const trigger=document.getElementById('empty-state-trigger'); const local=document.getElementById('local-video-player'); local.classList.add('hidden'); 
                if(v) { 
                    trigger.style.display = 'none'; 
                    iframe.classList.remove('hidden'); 
                    if(v.type === 'yt') { 
                        const origin = window.location.origin;
                        const embedUrl = `https://www.youtube.com/embed/${v.id}?autoplay=1&mute=0&controls=1&playsinline=1&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&enablejsapi=1&origin=${origin}&widget_referrer=${origin}`; 
                        if(iframe.src !== embedUrl) iframe.src = embedUrl; 
                    } 
                } 
                else { trigger.style.display = 'flex'; iframe.classList.add('hidden'); iframe.src=""; } 
            }); 
            
            // ========== UPDATED SEATS LISTENER ==========
            onValue(child(rr, 'seats'), s => { 
                currentRoomSeats = s.val() || {}; 
                updateSeat('seat1', currentRoomSeats.seat1, "UMAR"); 
                updateSeat('seat2', currentRoomSeats.seat2, "GURIYA"); 
                updateSeat('seat3', currentRoomSeats.seat3, "1"); 
                updateSeat('seat4', currentRoomSeats.seat4, "2"); 
                updateSeat('seat5', currentRoomSeats.seat5, "3"); 
                updateSeat('seat6', currentRoomSeats.seat6, "4"); 
                
                // heartbeat logic
                const hc = document.getElementById('heartbeat-container'); 
                const seat1Occupied = currentRoomSeats.seat1 && currentRoomSeats.seat1.uid; 
                const seat2Occupied = currentRoomSeats.seat2 && currentRoomSeats.seat2.uid; 
                if(seat1Occupied && seat2Occupied) { 
                    hc.classList.add('heartbeat-active'); 
                } else { 
                    hc.classList.remove('heartbeat-active'); 
                } 
                
                document.querySelectorAll('.action-menu-overlay').forEach(b => b.style.display = 'none'); 
            }); 
            
            onValue(child(rr, 'messages'), s => { 
                const chatArea = document.getElementById('chat-display-area'); 
                chatArea.innerHTML = ''; 
                if(s.exists()) { 
                    Object.values(s.val()).forEach(m => { 
                        if(m.timestamp > currentUserJoinTime) { 
                            if(m.type === 'system') { chatArea.innerHTML+=`<div class="chat-system-msg">${m.text}</div>`; } 
                            else { chatArea.innerHTML+=`<div class="chat-message-bubble"><b>${m.name}:</b> ${m.text}</div>`; } 
                        } 
                    }); 
                    setTimeout(forceScrollBottom, 100); 
                } 
            });
        };

        // ========== UPDATED SEAT RENDERING FUNCTION ==========
        window.updateSeat = (seatId, data, defaultName) => {
            const visualDiv = document.getElementById(`${seatId}-visual`);
            const nameSpan = document.getElementById(`${seatId}-name`);
            const container = document.getElementById(`cont-${seatId}`);
            if (!visualDiv || !nameSpan || !container) return;

            // reset classes & remove any extra mute badge
            container.classList.remove('seat-occupied', 'seat-locked', 'has-frame');
            const oldBadge = container.querySelector('.seat-mute-badge');
            if(oldBadge) oldBadge.remove();
            
            // Reset container border
            container.style.border = "2px solid #333";

            // Chair image already exists as .chair-bg-img inside container, keep it untouched.

            if (data && data.locked) {
                // locked seat: show lock icon on top of chair
                visualDiv.innerHTML = `<div class="visual-root"><i class="fa-solid fa-lock text-red-500 text-xl" style="filter:drop-shadow(0 0 5px black);"></i></div>`;
                container.classList.add('seat-locked');
                nameSpan.innerText = "Locked";
                nameSpan.className = "seat-name text-red-500";
            }
            else if (data && data.uid) {
                // occupied seat: display user dp and frame
                container.classList.add('seat-occupied');
                let html = `<div class="visual-root">`;
                html += `<img src="${data.pic || 'https://placehold.co/100'}" class="visual-img" onerror="this.src='https://placehold.co/100?text=U'">`;
                if (data.frame) {
                    html += `<img src="${data.frame}" class="visual-frame">`;
                    container.classList.add('has-frame');
                } else {
                    // if no frame, add green border to container
                    container.style.border = "2px solid #22c55e";
                }
                html += `</div>`;
                visualDiv.innerHTML = html;
                nameSpan.innerText = data.name || defaultName;
                nameSpan.className = "seat-name occupied text-green-500";

                // add mute badge if current user muted
                if (data.uid === currentUser?.uid && isMicMuted) {
                    const badge = document.createElement('div');
                    badge.className = 'seat-mute-badge';
                    badge.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
                    container.appendChild(badge);
                }
            } else {
                // empty seat: just chair visible, no dp
                visualDiv.innerHTML = ''; // clear any previous dp content
                nameSpan.innerText = defaultName;
                nameSpan.className = "seat-name";
                container.style.border = "2px solid #333";
            }
        };

        window.hideAllMicMenus = (e) => { if (!e.target.closest('.mic-container') && !e.target.closest('.mic-container-sm')) { document.querySelectorAll('.action-menu-overlay').forEach(b => b.style.display = 'none'); } };
        window.toggleMicMenu = (seatId, defName, event) => { event.stopPropagation(); document.querySelectorAll('.action-menu-overlay').forEach(b => b.style.display = 'none'); const menu = document.getElementById(`menu-${seatId}`); const seatData = currentRoomSeats[seatId]; const amIOwner = currentUser.uid === currentRoomOwner; const amISitting = seatData && seatData.uid === currentUser.uid; menu.innerHTML = ''; menu.style.display = 'flex'; if (amISitting) { menu.innerHTML = `<div class="btn-action btn-red" onclick="leaveSeat('${seatId}')">LEAVE</div>`; return; } if (seatData && seatData.locked) { if (amIOwner) { menu.innerHTML = `<div class="btn-action btn-yellow" onclick="toggleLock('${seatId}', false)">UNLOCK</div>`; } else { menu.innerHTML = `<div class="text-white text-xs p-2">LOCKED</div>`; } return; } if (seatData && seatData.uid) { if (amIOwner) { menu.innerHTML = `<div class="btn-action btn-yellow" onclick="unseatUser('${seatId}')">UNSEAT</div><div class="btn-action btn-red" onclick="kickUserFromRoom('${seatId}', '${seatData.uid}')">KICK</div>`; } else { menu.innerHTML = `<div class="text-white text-xs p-2">${seatData.name}</div>`; } return; } if (!seatData || !seatData.uid) { let html = `<div class="btn-action btn-green" onclick="sitDown('${seatId}', '${defName}')">SIT</div>`; if (amIOwner) { html += `<div class="btn-action btn-blue" onclick="toggleLock('${seatId}', true)">LOCK</div>`; } menu.innerHTML = html; } };
        window.leaveSeat = async (sid) => { const seatRef = ref(db, `rooms/${currentRoomId}/seats/${sid}`); onDisconnect(seatRef).cancel(); await remove(seatRef); document.getElementById(`menu-${sid}`).style.display = 'none'; };
        window.unseatUser = async (sid) => { await remove(ref(db, `rooms/${currentRoomId}/seats/${sid}`)); document.getElementById(`menu-${sid}`).style.display = 'none'; }; 
        window.kickUserFromRoom = async (sid, targetUid) => { await remove(ref(db, `rooms/${currentRoomId}/seats/${sid}`)); await set(ref(db, `rooms/${currentRoomId}/kicked/${targetUid}`), Date.now()); document.getElementById(`menu-${sid}`).style.display = 'none'; };
        window.toggleLock = async (sid, state) => { if(state) { await set(ref(db, `rooms/${currentRoomId}/seats/${sid}`), { locked: true }); } else { await remove(ref(db, `rooms/${currentRoomId}/seats/${sid}`)); } document.getElementById(`menu-${sid}`).style.display = 'none'; };
        window.sitDown = async (sid, def) => { const sr=ref(db, `rooms/${currentRoomId}/seats`); const s=currentRoomSeats; if(s[sid] && (s[sid].locked || s[sid].uid)) return; let unseatUpdates={}; ['seat1','seat2','seat3','seat4','seat5','seat6'].forEach(k => { if(s[k] && s[k].uid === currentUser.uid) unseatUpdates[k]=null; }); const userSnap = await get(ref(db, `users/${currentUser.uid}`)); const userData = userSnap.val(); const mySeatData = { uid: currentUser.uid, name: currentUser.displayName, pic: currentUser.photoURL, frame: userData.currentFrame || null }; const targetSeatRef = child(sr, sid); await update(sr, unseatUpdates); await set(targetSeatRef, mySeatData); onDisconnect(targetSeatRef).remove(); document.getElementById(`menu-${sid}`).style.display = 'none'; };

        window.openPropHouse = () => { const grid = document.getElementById('frame-grid'); grid.innerHTML = ''; get(ref(db, `users/${currentUser.uid}/currentFrame`)).then(snap => { const currentEquipped = snap.val(); for(let i=1; i<=50; i++) { const fileName = `./frames/frame_${i}.png`; const frameName = `Frame ${i}`; const isEquipped = (currentEquipped === fileName); const btnText = isEquipped ? "REMOVE" : "USE"; const btnClass = isEquipped ? "bg-gray-600 hover:bg-gray-700" : "bg-red-600 hover:bg-red-700"; const btnAction = isEquipped ? "removeFrame()" : `applyFrame('${fileName}')`; grid.innerHTML += `<div class="frame-card" style="display:flex"><div class="frame-preview-box"><div class="visual-root"><img src="${currentUser.photoURL}" class="visual-img"><img src="${fileName}" class="visual-frame" onerror="this.parentElement.parentElement.parentElement.style.display='none'"></div></div><span class="text-xs font-bold text-white mb-2">${frameName}</span><button onclick="${btnAction}" class="w-full ${btnClass} text-white text-xs py-1 rounded transition">${btnText}</button></div>`; } }); document.getElementById('prophouse-modal').classList.add('open'); };
        window.closePropHouse = () => document.getElementById('prophouse-modal').classList.remove('open');
        window.applyFrame = async (furl) => { await update(ref(db, `users/${currentUser.uid}`), { currentFrame: furl }); if(currentRoomId) { const seatsSnap = await get(ref(db, `rooms/${currentRoomId}/seats`)); if(seatsSnap.exists()) { const seats = seatsSnap.val(); Object.keys(seats).forEach(async (k) => { if(seats[k].uid === currentUser.uid) { await update(ref(db, `rooms/${currentRoomId}/seats/${k}`), { frame: furl }); } }); } } window.openPropHouse(); loadData(); Swal.fire({toast:true, icon:'success', title:'Frame Applied!', position:'top-end', showConfirmButton:false, timer:1500}); };
        window.removeFrame = async () => { await update(ref(db, `users/${currentUser.uid}`), { currentFrame: null }); if(currentRoomId) { const seatsSnap = await get(ref(db, `rooms/${currentRoomId}/seats`)); if(seatsSnap.exists()) { const seats = seatsSnap.val(); Object.keys(seats).forEach(async (k) => { if(seats[k].uid === currentUser.uid) { await update(ref(db, `rooms/${currentRoomId}/seats/${k}`), { frame: null }); } }); } } window.openPropHouse(); loadData(); Swal.fire({toast:true, icon:'info', title:'Frame Removed', position:'top-end', showConfirmButton:false, timer:1500}); };

        window.openEditModal = async () => { const s=await get(ref(db, `users/${currentUser.uid}`)); const d=s.val()||{}; document.getElementById('edit-name').value=d.username; document.getElementById('edit-bio').value=d.bio; let currentImg = d.photoURL; document.getElementById('edit-img-url').value=currentImg; currentEditingImg=currentImg; const container = document.getElementById('edit-preview-visual'); let html = `<div class="visual-root"><img src="${currentImg}" class="visual-img">`; if(d.currentFrame) html += `<img src="${d.currentFrame}" class="visual-frame">`; html += `</div>`; container.innerHTML = html; 
        document.getElementById('edit-email').value = currentUser.email || 'No Email';
        selectedGender = d.gender || null;
        updateGenderUI(d.lastGenderChange);
        document.getElementById('edit-modal').classList.add('open'); };
        window.closeEditModal=()=>document.getElementById('edit-modal').classList.remove('open');
        window.triggerImageUpload=()=>document.getElementById('image-upload').click();
        document.getElementById('image-upload').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{const i=new Image(); i.onload=()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');const s=300/Math.max(i.width,i.height);c.width=i.width*s;c.height=i.height*s;ctx.drawImage(i,0,0,c.width,c.height);const b64=c.toDataURL('image/jpeg',0.6);currentEditingImg=b64; document.getElementById('edit-img-url').value=b64; const container = document.getElementById('edit-preview-visual'); container.querySelector('.visual-img').src=b64; };i.src=ev.target.result;};r.readAsDataURL(f); });
        
        window.selectGender = (g) => {
            const now = Date.now();
            if (document.querySelector('.gender-option').classList.contains('locked-gender')) return;
            selectedGender = g;
            updateGenderUI(null, true); 
        }

        function updateGenderUI(lastChange, isSelectionMode=false) {
            const mBtn = document.getElementById('opt-male');
            const fBtn = document.getElementById('opt-female');
            const msg = document.getElementById('gender-lock-msg');
            mBtn.classList.remove('selected', 'locked-gender');
            fBtn.classList.remove('selected', 'locked-gender');
            msg.classList.add('hidden');
            const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
            const isLocked = lastChange && (Date.now() - lastChange < SEVEN_DAYS);
            if (selectedGender === 'male') mBtn.classList.add('selected');
            if (selectedGender === 'female') fBtn.classList.add('selected');
            if (isLocked && !isSelectionMode) { mBtn.classList.add('locked-gender'); fBtn.classList.add('locked-gender'); msg.classList.remove('hidden'); }
        }

        window.saveProfile=async()=>{ 
            const n=document.getElementById('edit-name').value; 
            const b=document.getElementById('edit-bio').value; 
            const u=document.getElementById('edit-img-url').value.trim(); 
            let finalImg = currentEditingImg; if(u && u.length > 5) finalImg = u; 
            let updateData = {username:n, bio:b, photoURL:finalImg};
            if (selectedGender) {
                const s = await get(ref(db, `users/${currentUser.uid}`));
                const d = s.val() || {};
                const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
                if (d.gender !== selectedGender) {
                    if (d.lastGenderChange && (Date.now() - d.lastGenderChange < SEVEN_DAYS)) {
                        return Swal.fire('Locked', 'You can only change gender once every 7 days.', 'error');
                    }
                    updateData.gender = selectedGender;
                    updateData.lastGenderChange = Date.now();
                }
            }
            await updateProfile(currentUser,{displayName:n,photoURL:finalImg}); 
            await update(ref(db,`users/${currentUser.uid}`), updateData); 
            document.getElementById('profile-name').innerText=n; 
            document.getElementById('profile-bio').innerText=b; 
            const container = document.getElementById('profile-visual-container'); 
            const hasFrame = document.querySelector('.visual-frame') !== null; 
            let html = `<div class="visual-root"><img src="${finalImg}" class="visual-img">`; 
            if(hasFrame) html += `<img src="${document.querySelector('.visual-frame').src}" class="visual-frame">`; 
            html += `</div>`; container.innerHTML = html; 
            closeEditModal(); 
        };
        
        window.toggleExitMenu = () => { const bar = document.getElementById('room-exit-bar'); const blocker = document.getElementById('room-exit-blocker'); if(bar.style.display === 'flex') { bar.style.display = 'none'; blocker.style.display = 'none'; } else { bar.style.display = 'flex'; blocker.style.display = 'block'; } };
        window.closeExitMenu = () => { document.getElementById('room-exit-bar').style.display = 'none'; document.getElementById('room-exit-blocker').style.display = 'none'; }
        
        window.minimizeRoom = () => { 
            closeExitMenu(); 
            document.getElementById('floating-room-btn').style.display = 'flex'; 
            document.getElementById('view-room').style.display = 'none'; 
            document.getElementById('view-room').classList.remove('view-active'); 
            document.getElementById('view-home').style.display = 'flex'; 
            document.getElementById('view-home').classList.add('view-active'); 
            document.getElementById('app-header').style.display = 'flex'; 
            document.getElementById('bottom-nav').classList.remove('hidden'); 
            document.getElementById('bottom-nav').classList.add('flex'); 
            if(currentRoomId) { 
                if(currentRoomData && currentRoomData.roomCover) {
                    document.getElementById('float-btn-img').src = currentRoomData.roomCover;
                } else {
                    document.getElementById('float-btn-img').src = `https://ui-avatars.com/api/?name=${currentRoomData?.roomName || 'Room'}`;
                }
            } 
        }

        window.restoreRoom = () => { document.getElementById('floating-room-btn').style.display='none'; switchTab('view-room'); };
        
        window.leaveRoomFull = () => { 
            closeExitMenu(); 
            
            // Clean up Rocket
            document.getElementById('rocket-container').classList.add('hidden');
            currentRoomExp = 0;
            lastRocketLevel = 0;

            document.getElementById('floating-room-btn').style.display = 'none'; 
            document.getElementById('view-room').style.display = 'none'; 
            document.getElementById('view-room').classList.remove('view-active'); 
            switchTab('view-home', document.querySelector('#btn-home')); 
            localStorage.removeItem('lastRoomId'); 
            
            if(currentRoomId) { 
                const userRef = ref(db, `rooms/${currentRoomId}/activeUsers/${currentUser.uid}`); 
                onDisconnect(userRef).cancel(); 
                remove(userRef); 
                
                if(currentRoomSeats) { 
                    Object.entries(currentRoomSeats).forEach(([key, val]) => { 
                        if(val && val.uid === currentUser.uid) { 
                            const sRef = ref(db, `rooms/${currentRoomId}/seats/${key}`); 
                            onDisconnect(sRef).cancel(); 
                            remove(sRef); 
                        } 
                    }); 
                } 
                if(currentRoomId === currentUser.uid) {
                    update(ref(db, `rooms/${currentRoomId}`), {isLive:false}); 
                }
            } 
            currentRoomId = null; 
            currentRoomData = null;
            document.getElementById('video-iframe').src = ""; 
            document.getElementById('local-video-player').classList.add('hidden'); 
        }

        window.switchTab = (vid, el) => { 
            const views = document.querySelectorAll('.view-section'); views.forEach(v => { v.style.display = 'none'; v.classList.remove('view-active'); });
            if(vid !== 'view-room' && currentRoomId) { document.getElementById('floating-room-btn').style.display='flex'; } else { document.getElementById('floating-room-btn').style.display='none'; }
            const targetView = document.getElementById(vid); if (targetView) { targetView.style.display = 'flex'; targetView.classList.add('view-active'); }
            if (vid === 'view-room') { document.getElementById('app-header').style.display = 'none'; document.getElementById('bottom-nav').classList.add('hidden'); } 
            else { document.getElementById('app-header').style.display = 'flex'; document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('header-home-content').classList.add('hidden'); document.getElementById('header-inbox-content').classList.add('hidden'); document.getElementById('header-profile-content').classList.add('hidden'); if (vid === 'view-home') { document.getElementById('header-home-content').classList.remove('hidden'); } else if (vid === 'view-inbox') { document.getElementById('header-inbox-content').classList.remove('hidden'); } else if (vid === 'view-profile') { document.getElementById('header-profile-content').classList.remove('hidden'); } } 
            if(el){ document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); } 
        };

        window.toggleSearch = () => document.getElementById('search-overlay').classList.toggle('open');
        window.searchUser = async () => { const i = document.getElementById('search-input').value.trim(); if(!i)return; const s = await get(ref(db, `idToUid/${i}`)); const r = document.getElementById('search-result'); if(!s.exists()){r.innerHTML="<span class='text-red-500'>ID Not Found</span>";return;} const u = s.val(); if(u===currentUser.uid){r.innerHTML="<span class='text-yellow-500'>This is you!</span>";return;} const ud = (await get(ref(db, `users/${u}`))).val(); const friendCheck = await get(ref(db, `users/${currentUser.uid}/friends/${u}`)); let btnHtml = "FOLLOW"; let btnClass = "bg-blue-600"; let btnDisabled = ""; if (friendCheck.exists()) { btnHtml = "FOLLOWING"; btnClass = "bg-gray-600 cursor-not-allowed"; btnDisabled = "disabled"; } r.innerHTML=`<div class='flex bg-gray-900 p-3 rounded-xl items-center justify-between border border-gray-700 shadow-lg'><div class='flex gap-3 items-center'><img src="${ud.photoURL}" class="w-10 h-10 rounded-full border border-gray-600"><span class="text-white font-bold text-sm">${ud.username}</span></div><button onclick="sendReq('${u}', this)" class='${btnClass} text-xs px-2 py-1 rounded font-bold text-white' ${btnDisabled}>${btnHtml}</button></div>`; };
        window.sendReq = async(u, btn)=>{ await set(ref(db,`users/${u}/inbox/requests/${currentUser.uid}`),{fromName:currentUser.displayName,fromUid:currentUser.uid,type:'req'}); btn.innerText = "FOLLOWING"; btn.classList.remove('bg-blue-600'); btn.classList.add('bg-gray-600'); btn.disabled = true; };
        window.acceptFriend = async(fid,fn)=>{ await update(ref(db),{[`users/${currentUser.uid}/friends/${fid}`]:fn, [`users/${fid}/friends/${currentUser.uid}`]:currentUser.displayName, [`users/${currentUser.uid}/inbox/requests/${fid}`]:null}); };
        window.delNotif=(p)=>remove(ref(db,`users/${currentUser.uid}/inbox/${p}`));
        
        // ROOM CHAT INPUT LOGIC
        window.openRoomChatInput = () => {
            document.getElementById('room-icons-container').style.display = 'none';
            document.getElementById('room-chat-input-layer').style.display = 'flex';
            document.getElementById('room-chat-input-field').focus();
        };

        window.closeRoomChatInput = () => {
            document.getElementById('room-chat-input-layer').style.display = 'none';
            document.getElementById('room-icons-container').style.display = 'flex';
        };

        window.sendRoomMessage = (e) => {
            e.preventDefault();
            const input = document.getElementById('room-chat-input-field');
            const text = input.value.trim();
            if(text && currentRoomId){ 
                push(ref(db, `rooms/${currentRoomId}/messages`), {name:currentUser.displayName, text:text, timestamp: Date.now()}); 
                input.value=''; 
                closeRoomChatInput();
                setTimeout(forceScrollBottom, 100); 
            }
        };

        // MIC & SPEAKER TOGGLES
        window.toggleMic = () => {
            const btn = document.getElementById('btn-mic');
            isMicMuted = !isMicMuted;
            if(isMicMuted) {
                btn.className = 'fa-solid fa-microphone-slash room-icon-btn text-gray-500';
            } else {
                btn.className = 'fa-solid fa-microphone room-icon-btn text-white';
            }
            if(currentRoomId) updateSeatMuteStatus();
        };

        function updateSeatMuteStatus() {
            for (let i = 1; i <= 6; i++) {
                const sid = `seat${i}`;
                if (currentRoomSeats[sid] && currentRoomSeats[sid].uid === currentUser.uid) {
                    const cont = document.getElementById(`cont-${sid}`);
                    const existingBadge = cont.querySelector('.seat-mute-badge');
                    if(existingBadge) existingBadge.remove();
                    if(isMicMuted) {
                        const badge = document.createElement('div');
                        badge.className = 'seat-mute-badge';
                        badge.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
                        cont.appendChild(badge);
                    }
                }
            }
        }

        window.toggleSpeaker = () => {
            const btn = document.getElementById('btn-speaker');
            const iframe = document.getElementById('video-iframe');
            isSpeakerMuted = !isSpeakerMuted;
            
            if(isSpeakerMuted) {
                btn.className = 'fa-solid fa-volume-xmark room-icon-btn text-gray-500';
                if(iframe) iframe.contentWindow.postMessage(JSON.stringify({event: 'command', func: 'mute', args: ''}), '*');
            } else {
                btn.className = 'fa-solid fa-volume-high room-icon-btn text-white';
                if(iframe) iframe.contentWindow.postMessage(JSON.stringify({event: 'command', func: 'unmute', args: ''}), '*');
            }
        };

        // ROOM USERS LIST
        window.showRoomUserList = async () => {
            if(!currentRoomId) return;
            const usersSnap = await get(ref(db, `rooms/${currentRoomId}/activeUsers`));
            const listContainer = document.getElementById('room-users-list');
            listContainer.innerHTML = '';
            
            if(usersSnap.exists()) {
                const users = usersSnap.val();
                for (const [uid, name] of Object.entries(users)) {
                    const uSnap = await get(ref(db, `users/${uid}`));
                    const uData = uSnap.val() || {};
                    const pic = uData.photoURL || `https://ui-avatars.com/api/?name=${name}`;
                    
                    listContainer.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-800 p-2 rounded">
                        <div class="flex items-center gap-3">
                            <img src="${pic}" class="w-8 h-8 rounded-full border border-gray-600">
                            <span class="text-white text-sm font-medium">${name}</span>
                        </div>
                    </div>`;
                }
            } else {
                listContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No users found.</p>';
            }
            document.getElementById('room-users-modal').classList.add('open');
        };
        window.closeRoomUsers = () => document.getElementById('room-users-modal').classList.remove('open');

        window.clearScreen = () => { set(ref(db, `rooms/${currentRoomId}/videoId`), null); document.getElementById('local-video-player').classList.add('hidden'); document.getElementById('local-video-player').src = ""; document.getElementById('screen-placeholder').classList.remove('hidden'); document.getElementById('video-iframe').classList.add('hidden'); document.getElementById('video-iframe').src = ""; };
        
        window.openDirectChat = (friendUid, friendName) => { 
            currentChatFriendId = friendUid; 
            document.getElementById('dm-friend-name').innerText = friendName; 
            const chatId = [currentUser.uid, friendUid].sort().join('_'); 
            const chatRef = ref(db, `direct_messages/${chatId}`); 
            document.getElementById('dm-messages').innerHTML = '<p class="text-center text-gray-500 text-xs">Loading...</p>'; 
            onValue(chatRef, (snap) => { 
                const div = document.getElementById('dm-messages'); 
                div.innerHTML = ''; 
                if(snap.exists()) { 
                    Object.values(snap.val()).forEach(msg => { 
                        const isMe = msg.uid === currentUser.uid; 
                        div.innerHTML += `<div class="p-2 text-sm max-w-[70%] mb-1 ${isMe ? 'chat-bubble-me' : 'chat-bubble-friend'} shadow-sm">${msg.text}</div>`; 
                    }); 
                    div.scrollTop = div.scrollHeight; 
                } else div.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Start messaging...</p>'; 
            }); 
            document.querySelectorAll('.view-section').forEach(e => { e.classList.remove('view-active'); e.style.display = 'none'; });
            const chatView = document.getElementById('view-chat'); chatView.classList.remove('hidden'); chatView.classList.add('flex', 'view-active'); chatView.style.display = 'flex';
            document.getElementById('app-header').style.display = 'none'; document.getElementById('bottom-nav').classList.add('hidden'); 
        };

        window.closeDirectChat = () => { document.getElementById('view-chat').classList.add('hidden'); document.getElementById('view-chat').classList.remove('flex'); document.getElementById('view-chat').style.display = 'none'; switchTab('view-inbox', document.getElementById('btn-inbox')); };
        document.getElementById('dm-form').addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById('dm-input'); const text = input.value.trim(); if(text && currentChatFriendId) { const chatId = [currentUser.uid, currentChatFriendId].sort().join('_'); push(ref(db, `direct_messages/${chatId}`), { uid: currentUser.uid, text: text, timestamp: Date.now() }); input.value = ''; } });
        
        // FRIEND PROFILE VIEW
        window.viewFriendProfile = async (uid) => {
            if(!uid) return;
            const snap = await get(ref(db, `users/${uid}`));
            if(!snap.exists()) return;
            const d = snap.val();
            
            document.getElementById('fp-image').src = d.photoURL || 'https://placehold.co/100';
            document.getElementById('fp-name').innerText = d.username;
            document.getElementById('fp-id').innerText = d.customId;
            document.getElementById('fp-bio').innerText = d.bio || "No Bio";
            document.getElementById('fp-gender').src = d.gender === 'female' ? './female.png' : './male.png';
            
            const fCheck = await get(ref(db, `users/${currentUser.uid}/friends/${uid}`));
            const btn = document.getElementById('fp-action-btn');
            
            if(fCheck.exists()) {
                btn.innerText = "UNFOLLOW";
                btn.classList.replace('bg-blue-600', 'bg-gray-600');
                btn.onclick = () => unfollowUser(uid);
            } else {
                btn.innerText = "FOLLOW";
                btn.classList.replace('bg-gray-600', 'bg-blue-600');
                btn.onclick = () => followUser(uid, btn);
            }
            
            document.getElementById('friend-profile-modal').classList.add('open');
        }

        window.closeFriendProfile = () => document.getElementById('friend-profile-modal').classList.remove('open');
        
        window.followUser = async (uid, btn) => {
            await set(ref(db, `users/${uid}/inbox/requests/${currentUser.uid}`), {fromName: currentUser.displayName, fromUid: currentUser.uid, type: 'req'});
            btn.innerText = "REQUESTED";
            btn.classList.replace('bg-blue-600', 'bg-gray-600');
        }

        window.unfollowUser = async (uid) => {
            await remove(ref(db, `users/${currentUser.uid}/friends/${uid}`));
            await remove(ref(db, `users/${uid}/friends/${currentUser.uid}`));
            closeFriendProfile();
            Swal.fire('Unfollowed', 'User removed from friends', 'success');
        }

        window.showInviteModal = async () => { if(!currentRoomId) return; const friendsSnap = await get(ref(db, `users/${currentUser.uid}/friends`)); if(!friendsSnap.exists()) return Swal.fire({toast:true, icon:'info', title:'No friends to invite', position:'top'}); let html = `<div class="flex flex-col gap-2 max-h-60 overflow-y-auto">`; Object.entries(friendsSnap.val()).forEach(([fid, fname]) => { html += `<div class="flex justify-between items-center bg-zinc-800 p-3 rounded"><span class="text-white text-sm font-bold">${fname}</span><button onclick="window.inviteUser('${fid}', this)" class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-500 font-bold">INVITE</button></div>`; }); html += `</div>`; Swal.fire({ title: 'Invite Friends', html: html, background: '#111', color: '#fff', showConfirmButton: false, showCloseButton: true }); };
        window.inviteUser = async (fid, btn) => { btn.innerHTML = "INVITED"; btn.classList.add('opacity-50', 'cursor-not-allowed'); btn.classList.remove('bg-blue-600', 'hover:bg-blue-500'); btn.classList.add('bg-gray-600'); btn.disabled = true; const notifRef = ref(db, `users/${fid}/inbox/invites/${Date.now()}`); await set(notifRef, { fromName: currentUser.displayName, fromUid: currentUser.uid, roomId: currentRoomId, type: 'invite' }); setTimeout(() => { if(btn) { btn.innerHTML = "INVITE"; btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600'); btn.classList.add('bg-blue-600', 'hover:bg-blue-500'); btn.disabled = false; } }, 120000); };
        window.copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => { Swal.fire({ toast: true, icon: 'success', title: 'ID Copied!', position: 'top', showConfirmButton: false, timer: 1500 }); }).catch(err => console.error('Failed to copy', err)); };
        window.showFriendList = async (type) => { const friendsSnap = await get(ref(db, `users/${currentUser.uid}/friends`)); let title = type === 'following' ? 'Following' : 'Fans'; let html = `<div class="flex flex-col gap-2 max-h-60 overflow-y-auto text-left">`; if(!friendsSnap.exists()) { html += `<div class="text-gray-400 text-center text-sm py-4">No users found.</div>`; } else { Object.entries(friendsSnap.val()).forEach(([fid, fname]) => { html += `<div class="flex items-center gap-3 bg-gray-800 p-2 rounded mb-1"><div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white text-xs">${fname[0]}</div><span class="text-white text-sm font-medium">${fname}</span></div>`; }); } html += `</div>`; Swal.fire({ title: title, html: html, background: '#111', color: '#fff', showConfirmButton: false, showCloseButton: true }); };

        // Chair image fallback
        document.querySelectorAll('.chair-bg-img').forEach(img => {
            img.onerror = () => { img.style.display = 'none'; };
        });
    </script>
</body>
                              </html>
